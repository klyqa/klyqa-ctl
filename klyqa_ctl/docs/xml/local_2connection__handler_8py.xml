<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.1" xml:lang="en-US">
  <compounddef id="local_2connection__handler_8py" kind="file" language="Python">
    <compoundname>connection_handler.py</compoundname>
    <innerclass refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler" prot="public">local::connection_handler::LocalConnectionHandler</innerclass>
    <innernamespace refid="namespacelocal_1_1connection__handler">local::connection_handler</innernamespace>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1" refid="namespacelocal_1_1connection__handler" refkind="compound"><highlight class="stringliteral">&quot;&quot;&quot;Local<sp/>device<sp/>communication&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>__future__<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>annotations</highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>asyncio</highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>asyncio<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>AbstractEventLoop,<sp/>CancelledError,<sp/>Task</highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>datetime</highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>json</highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>select</highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>socket</highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>typing<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>Any</highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>klyqa_ctl.communication.connection_handler<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>ConnectionHandler</highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>klyqa_ctl.communication.local.connection<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="15"><highlight class="normal"><sp/><sp/><sp/><sp/>AesConnectionState,</highlight></codeline>
<codeline lineno="16"><highlight class="normal"><sp/><sp/><sp/><sp/>DeviceTcpReturn,</highlight></codeline>
<codeline lineno="17"><highlight class="normal"><sp/><sp/><sp/><sp/>TcpConnection,</highlight></codeline>
<codeline lineno="18"><highlight class="normal">)</highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>klyqa_ctl.communication.local.data_package<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="20"><highlight class="normal"><sp/><sp/><sp/><sp/>DataPackage,</highlight></codeline>
<codeline lineno="21"><highlight class="normal"><sp/><sp/><sp/><sp/>PackageException,</highlight></codeline>
<codeline lineno="22"><highlight class="normal"><sp/><sp/><sp/><sp/>PackageType,</highlight></codeline>
<codeline lineno="23"><highlight class="normal">)</highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/><ref refid="namespaceklyqa__ctl_1_1controller__data" kindref="compound">klyqa_ctl.controller_data</ref><sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>ControllerData</highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/><ref refid="namespaceklyqa__ctl_1_1devices_1_1device" kindref="compound">klyqa_ctl.devices.device</ref><sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>CommandWithCheckValues,<sp/>Device</highlight></codeline>
<codeline lineno="26"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/><ref refid="namespaceklyqa__ctl_1_1devices_1_1light_1_1commands" kindref="compound">klyqa_ctl.devices.light.commands</ref><sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>PingCommand,<sp/>TransitionCommand</highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/><ref refid="namespaceklyqa__ctl_1_1devices_1_1response__identity__message" kindref="compound">klyqa_ctl.devices.response_identity_message</ref><sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>ResponseIdentityMessage</highlight></codeline>
<codeline lineno="28"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general" kindref="compound">klyqa_ctl.general.general</ref><sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="29"><highlight class="normal"><sp/><sp/><sp/><sp/>DEFAULT_MAX_COM_PROC_TIMEOUT_SECS,</highlight></codeline>
<codeline lineno="30"><highlight class="normal"><sp/><sp/><sp/><sp/>LOGGER,</highlight></codeline>
<codeline lineno="31"><highlight class="normal"><sp/><sp/><sp/><sp/>SEND_LOOP_MAX_SLEEP_TIME,</highlight></codeline>
<codeline lineno="32"><highlight class="normal"><sp/><sp/><sp/><sp/>SEPARATION_WIDTH,</highlight></codeline>
<codeline lineno="33"><highlight class="normal"><sp/><sp/><sp/><sp/>Command,</highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/><sp/><sp/>ReferencePass,</highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/><sp/><sp/>TypeJson,</highlight></codeline>
<codeline lineno="36"><highlight class="normal"><sp/><sp/><sp/><sp/>task_log,</highlight></codeline>
<codeline lineno="37"><highlight class="normal"><sp/><sp/><sp/><sp/>task_log_debug,</highlight></codeline>
<codeline lineno="38"><highlight class="normal"><sp/><sp/><sp/><sp/>task_log_error,</highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/><sp/><sp/>task_log_trace,</highlight></codeline>
<codeline lineno="40"><highlight class="normal"><sp/><sp/><sp/><sp/>task_log_trace_ex,</highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/><sp/><sp/>task_name,</highlight></codeline>
<codeline lineno="42"><highlight class="normal">)</highlight></codeline>
<codeline lineno="43"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1message" kindref="compound">klyqa_ctl.general.message</ref><sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>BroadCastMessage,<sp/>Message,<sp/>MessageState</highlight></codeline>
<codeline lineno="44"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1unit__id" kindref="compound">klyqa_ctl.general.unit_id</ref><sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>UnitId</highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight></codeline>
<codeline lineno="46"><highlight class="normal"></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>Cryptodome.Cipher<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>AES<sp/><sp/></highlight><highlight class="comment">#<sp/>provided<sp/>by<sp/>pycryptodome</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal"></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>ImportError:</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>Crypto.Cipher<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>AES<sp/><sp/></highlight><highlight class="comment">#<sp/>provided<sp/>by<sp/>pycryptodome</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight></codeline>
<codeline lineno="51" refid="namespacelocal_1_1connection__handler_1a41af5c536a6af4617df5c96742204c77" refkind="member"><highlight class="normal">SO_BINDTODEVICE_LINUX:<sp/>int<sp/>=<sp/>25</highlight></codeline>
<codeline lineno="52"><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight></codeline>
<codeline lineno="54" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler" kindref="compound">LocalConnectionHandler</ref>(ConnectionHandler):<sp/><sp/></highlight><highlight class="comment">#<sp/>type:<sp/>ignore[misc]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Data<sp/>communicator<sp/>for<sp/>local<sp/>device<sp/>connection.</highlight></codeline>
<codeline lineno="56"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="57"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>Important:<sp/>Call<sp/>async<sp/>function<sp/>shutdown()<sp/>after<sp/>using<sp/>send<sp/>method,</highlight></codeline>
<codeline lineno="58"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>or<sp/>the<sp/>send<sp/>message<sp/>loop<sp/>will<sp/>keep<sp/>running.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"></highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Set<sp/>of<sp/>current<sp/>accepted<sp/>connections<sp/>to<sp/>an<sp/>IP.<sp/>One<sp/>connection<sp/>is<sp/>most<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>the<sp/>time<sp/>enough<sp/>to<sp/>send<sp/>all<sp/>messages<sp/>for<sp/>that<sp/>device<sp/>behind<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>connection<sp/>(in<sp/>the<sp/>aes<sp/>send<sp/>message<sp/>method).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>If<sp/>connection<sp/>is<sp/>currently<sp/>finishing<sp/>due<sp/>to<sp/>sent<sp/>messages<sp/>and<sp/>no</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>messages<sp/>left<sp/>for<sp/>that<sp/>device<sp/>and<sp/>a<sp/>new<sp/>message<sp/>appears<sp/>in<sp/>the<sp/>queue,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>send<sp/>a<sp/>new<sp/>broadcast<sp/>and<sp/>establish<sp/>a<sp/>new<sp/>connection.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/>_attr_current_addr_connections:<sp/>set[str]</highlight></codeline>
<codeline lineno="68"><highlight class="normal"></highlight></codeline>
<codeline lineno="69" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0c713697632158651e042a125d3a5dc6" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0c713697632158651e042a125d3a5dc6" kindref="member">__init__</ref>(</highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>controller_data:<sp/>ControllerData,</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>server_ip:<sp/>str<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;0.0.0.0&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>network_interface:<sp/>str<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Initialize<sp/>local<sp/>connection<sp/>handler.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="76"><highlight class="normal"></highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ae4afde55789d67ca141f32cd0f2c2493" kindref="member">_attr_controller_data</ref>_attr_controller_data:<sp/>ControllerData<sp/>=<sp/>controller_data</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a6493a246d69932bec84ca4e7b6b388fe" kindref="member">_attr_devices</ref>_attr_devices:<sp/>dict[str,<sp/>Device]<sp/>=<sp/>controller_data.devices</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8a5ac8d6f4dea27c50196afd9652a346" kindref="member">_attr_tcp</ref>_attr_tcp:<sp/>socket.socket<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ad5c7aa585d0caeb47f8faa346190a3a7" kindref="member">_attr_udp</ref>_attr_udp:<sp/>socket.socket<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aecb45be484a4b7c1ae8c1e9bca8c3ee7" kindref="member">_attr_server_ip</ref>_attr_server_ip:<sp/>str<sp/>=<sp/>server_ip</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>here<sp/>message<sp/>queue<sp/>key<sp/>needs<sp/>to<sp/>be<sp/>string<sp/>not<sp/>UnitId<sp/>to<sp/>be<sp/>hashable</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>for<sp/>dictionaries<sp/>and<sp/>sets</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9743831efb2f611d2348a5602e7ef302" kindref="member">_attr_message_queue</ref>_attr_message_queue:<sp/>dict[str,<sp/>list[Message]]<sp/>=<sp/>{}</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a3f66f22f149d55906c40fff1df106447" kindref="member">__attr_send_loop_sleep</ref>__attr_send_loop_sleep:<sp/>Task<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a98999cb56a4b93a97541deaf9cb3cb35" kindref="member">__attr_tasks_done</ref>__attr_tasks_done:<sp/>list[</highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tuple[Task,<sp/>datetime.datetime,<sp/>datetime.datetime]</highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>]<sp/>=<sp/>[]</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a129a15e834ca7f110952eb7e58ac0013" kindref="member">__attr_tasks_undone</ref>__attr_tasks_undone:<sp/>list[tuple[Task,<sp/>datetime.datetime]]<sp/>=<sp/>[]</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a34d28f73c88f0446897aa36b5c7b10ac" kindref="member">_attr_handlec_connections_task</ref>_attr_handlec_connections_task:<sp/>Task<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1afab4cc85b5f9fa33a1e32e71433c3c2b" kindref="member">_attr_handle_connections_task_end_now</ref>_attr_handle_connections_task_end_now:<sp/>bool<sp/>=<sp/></highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1feda3b6377035d969d4e21b4540ef14" kindref="member">__attr_read_tcp_task</ref>__attr_read_tcp_task:<sp/>Task<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac3bb2f33c3dd9a46ba505569ec001ab3" kindref="member">msg_ttl_task</ref>msg_ttl_task:<sp/>Task<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="94" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a87b7dc39e44da267c0eefd59d2b2672e" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a87b7dc39e44da267c0eefd59d2b2672e" kindref="member">_attr_current_addr_connections</ref>_attr_current_addr_connections<sp/>=<sp/>set()</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1af3e5bcdcf6810250f40c567df909e41f" kindref="member">_attr_network_interface</ref>_attr_network_interface:<sp/>str<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/>network_interface</highlight></codeline>
<codeline lineno="96"><highlight class="normal"></highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="98" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a159e60e3f78301ef89df33d9adaebbde" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a159e60e3f78301ef89df33d9adaebbde" kindref="member">network_interface</ref>(self)<sp/>-&gt;<sp/>str<sp/>|<sp/>None:</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1af3e5bcdcf6810250f40c567df909e41f" kindref="member">_attr_network_interface</ref>_attr_network_interface</highlight></codeline>
<codeline lineno="100"><highlight class="normal"></highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@network_interface.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="102" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a6ef3ac8849218db44b014909d1f8146a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a159e60e3f78301ef89df33d9adaebbde" kindref="member">network_interface</ref>(self,<sp/>network_interface:<sp/>str<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="103" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1af3e5bcdcf6810250f40c567df909e41f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1af3e5bcdcf6810250f40c567df909e41f" kindref="member">_attr_network_interface</ref>_attr_network_interface<sp/>=<sp/>network_interface</highlight></codeline>
<codeline lineno="104"><highlight class="normal"></highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="106" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8f938ae53b3c24bbdc02f377671cf263" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8f938ae53b3c24bbdc02f377671cf263" kindref="member">controller_data</ref>(self)<sp/>-&gt;<sp/>ControllerData:</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ae4afde55789d67ca141f32cd0f2c2493" kindref="member">_attr_controller_data</ref>_attr_controller_data</highlight></codeline>
<codeline lineno="108"><highlight class="normal"></highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@controller_data.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="110" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac7312a0c1fbe8ad9bcbd585e66e9e74c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8f938ae53b3c24bbdc02f377671cf263" kindref="member">controller_data</ref>(self,<sp/>controller_data:<sp/>ControllerData)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="111" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ae4afde55789d67ca141f32cd0f2c2493" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ae4afde55789d67ca141f32cd0f2c2493" kindref="member">_attr_controller_data</ref>_attr_controller_data<sp/>=<sp/>controller_data</highlight></codeline>
<codeline lineno="112"><highlight class="normal"></highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="114" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a4d307f6bd0b66f3cb9fac3057fc87972" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a4d307f6bd0b66f3cb9fac3057fc87972" kindref="member">devices</ref>(self)<sp/>-&gt;<sp/>dict[str,<sp/>Device]:</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a6493a246d69932bec84ca4e7b6b388fe" kindref="member">_attr_devices</ref>_attr_devices</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@devices.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="118" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8d7418a9f89b4622dd814bd1c9ea4028" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a4d307f6bd0b66f3cb9fac3057fc87972" kindref="member">devices</ref>(self,<sp/>devices:<sp/>dict[str,<sp/>Device])<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="119" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a6493a246d69932bec84ca4e7b6b388fe" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a6493a246d69932bec84ca4e7b6b388fe" kindref="member">_attr_devices</ref>_attr_devices<sp/>=<sp/>devices</highlight></codeline>
<codeline lineno="120"><highlight class="normal"></highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="122" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref>(self)<sp/>-&gt;<sp/>socket.socket<sp/>|<sp/>None:</highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8a5ac8d6f4dea27c50196afd9652a346" kindref="member">_attr_tcp</ref>_attr_tcp</highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@tcp.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="126" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref>(self,<sp/>tcp:<sp/>socket.socket<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="127" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8a5ac8d6f4dea27c50196afd9652a346" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8a5ac8d6f4dea27c50196afd9652a346" kindref="member">_attr_tcp</ref>_attr_tcp<sp/>=<sp/>tcp</highlight></codeline>
<codeline lineno="128"><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="130" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref>(self)<sp/>-&gt;<sp/>socket.socket<sp/>|<sp/>None:</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ad5c7aa585d0caeb47f8faa346190a3a7" kindref="member">_attr_udp</ref>_attr_udp</highlight></codeline>
<codeline lineno="132"><highlight class="normal"></highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@udp.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="134" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref>(self,<sp/>udp:<sp/>socket.socket<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="135" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ad5c7aa585d0caeb47f8faa346190a3a7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ad5c7aa585d0caeb47f8faa346190a3a7" kindref="member">_attr_udp</ref>_attr_udp<sp/>=<sp/>udp</highlight></codeline>
<codeline lineno="136"><highlight class="normal"></highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="138" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab8a8460610614f6230bbf346fc532269" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab8a8460610614f6230bbf346fc532269" kindref="member">server_ip</ref>(self)<sp/>-&gt;<sp/>str:</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aecb45be484a4b7c1ae8c1e9bca8c3ee7" kindref="member">_attr_server_ip</ref>_attr_server_ip</highlight></codeline>
<codeline lineno="140"><highlight class="normal"></highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@server_ip.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="142" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aebdf9201096932f18c4f28e1e084d267" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab8a8460610614f6230bbf346fc532269" kindref="member">server_ip</ref>(self,<sp/>server_ip:<sp/>str)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="143" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aecb45be484a4b7c1ae8c1e9bca8c3ee7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aecb45be484a4b7c1ae8c1e9bca8c3ee7" kindref="member">_attr_server_ip</ref>_attr_server_ip<sp/>=<sp/>server_ip</highlight></codeline>
<codeline lineno="144"><highlight class="normal"></highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="146" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref>(self)<sp/>-&gt;<sp/>dict[str,<sp/>list[Message]]:</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9743831efb2f611d2348a5602e7ef302" kindref="member">_attr_message_queue</ref>_attr_message_queue</highlight></codeline>
<codeline lineno="148"><highlight class="normal"></highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@message_queue.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="150" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref>(self,<sp/>message_queue:<sp/>dict[str,<sp/>list[Message]])<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="151" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9743831efb2f611d2348a5602e7ef302" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9743831efb2f611d2348a5602e7ef302" kindref="member">_attr_message_queue</ref>_attr_message_queue<sp/>=<sp/>message_queue</highlight></codeline>
<codeline lineno="152"><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="154" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a68a3816075b8ed0c70771734a769c637" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2b51fa92e94e68a7ce1cfa9476beee3b" kindref="member">__send_loop_sleep</ref>(self)<sp/>-&gt;<sp/>Task<sp/>|<sp/>None:</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a3f66f22f149d55906c40fff1df106447" kindref="member">__attr_send_loop_sleep</ref>__attr_send_loop_sleep</highlight></codeline>
<codeline lineno="156"><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@__send_loop_sleep.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="158" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aaf4e9059c5e6eb4c022552d5e2b61393" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2b51fa92e94e68a7ce1cfa9476beee3b" kindref="member">__send_loop_sleep</ref>(self,<sp/>send_loop_sleep:<sp/>Task<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="159" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a3f66f22f149d55906c40fff1df106447" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a3f66f22f149d55906c40fff1df106447" kindref="member">__attr_send_loop_sleep</ref>__attr_send_loop_sleep<sp/>=<sp/>send_loop_sleep</highlight></codeline>
<codeline lineno="160"><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="162" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ada6417ada8d133670d693cfc41524ace" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ada6417ada8d133670d693cfc41524ace" kindref="member">__tasks_done</ref>(</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>list[tuple[Task,<sp/>datetime.datetime,<sp/>datetime.datetime]]:</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a98999cb56a4b93a97541deaf9cb3cb35" kindref="member">__attr_tasks_done</ref>__attr_tasks_done</highlight></codeline>
<codeline lineno="166"><highlight class="normal"></highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@__tasks_done.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="168" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac9063fb97f6994d217bbf2de54e52284" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ada6417ada8d133670d693cfc41524ace" kindref="member">__tasks_done</ref>(</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tasks_done:<sp/>list[tuple[Task,<sp/>datetime.datetime,<sp/>datetime.datetime]],</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="172" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a98999cb56a4b93a97541deaf9cb3cb35" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a98999cb56a4b93a97541deaf9cb3cb35" kindref="member">__attr_tasks_done</ref>__attr_tasks_done<sp/>=<sp/>tasks_done</highlight></codeline>
<codeline lineno="173"><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="175" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a317b8c3b4d3ebaa16eeaed026c561426" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aad755d50b86f166cc07d60a73be07d27" kindref="member">__tasks_undone</ref>(self)<sp/>-&gt;<sp/>list[tuple[Task,<sp/>datetime.datetime]]:</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a129a15e834ca7f110952eb7e58ac0013" kindref="member">__attr_tasks_undone</ref>__attr_tasks_undone</highlight></codeline>
<codeline lineno="177"><highlight class="normal"></highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@__tasks_undone.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="179" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac233ab5749ff539db60868d759194458" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aad755d50b86f166cc07d60a73be07d27" kindref="member">__tasks_undone</ref>(</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,<sp/>tasks_undone:<sp/>list[tuple[Task,<sp/>datetime.datetime]]</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="182" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a129a15e834ca7f110952eb7e58ac0013" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a129a15e834ca7f110952eb7e58ac0013" kindref="member">__attr_tasks_undone</ref>__attr_tasks_undone<sp/>=<sp/>tasks_undone</highlight></codeline>
<codeline lineno="183"><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="185" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e62dc20801dc3d832dbd1dd0373ba17" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1f5deccf8a67169afa7e67c53cd569e5" kindref="member">handle_connections_task</ref>(self)<sp/>-&gt;<sp/>Task<sp/>|<sp/>None:</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a34d28f73c88f0446897aa36b5c7b10ac" kindref="member">_attr_handlec_connections_task</ref>_attr_handlec_connections_task</highlight></codeline>
<codeline lineno="187"><highlight class="normal"></highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@handle_connections_task.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="189" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a44ce408a0cb35854a4ac1dfe541090b4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1f5deccf8a67169afa7e67c53cd569e5" kindref="member">handle_connections_task</ref>(</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,<sp/>handle_connections_tasks:<sp/>Task<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="192" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a34d28f73c88f0446897aa36b5c7b10ac" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a34d28f73c88f0446897aa36b5c7b10ac" kindref="member">_attr_handlec_connections_task</ref>_attr_handlec_connections_task<sp/>=<sp/>handle_connections_tasks</highlight></codeline>
<codeline lineno="193"><highlight class="normal"></highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="195" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1acf31322d19d937f12f736c7f4c3d9f22" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a828ca7aef56188a7dd4bd1b18b7cea85" kindref="member">handle_connections_task_end_now</ref>(self)<sp/>-&gt;<sp/>bool:</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1afab4cc85b5f9fa33a1e32e71433c3c2b" kindref="member">_attr_handle_connections_task_end_now</ref>_attr_handle_connections_task_end_now</highlight></codeline>
<codeline lineno="197"><highlight class="normal"></highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@handle_connections_task_end_now.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="199" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac2ea1078fc435b2f80b549c4d17ab6d4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a828ca7aef56188a7dd4bd1b18b7cea85" kindref="member">handle_connections_task_end_now</ref>(</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,<sp/>handle_connections_task_end_now:<sp/>bool</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="202" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1afab4cc85b5f9fa33a1e32e71433c3c2b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1afab4cc85b5f9fa33a1e32e71433c3c2b" kindref="member">_attr_handle_connections_task_end_now</ref>_attr_handle_connections_task_end_now<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>handle_connections_task_end_now</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="205"><highlight class="normal"></highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="207" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a348da0cbea474b77e02a7960340aed36" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab01f2e382ae425e5bc2818772d059a56" kindref="member">__read_tcp_task</ref>(self)<sp/>-&gt;<sp/>Task<sp/>|<sp/>None:</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1feda3b6377035d969d4e21b4540ef14" kindref="member">__attr_read_tcp_task</ref>__attr_read_tcp_task</highlight></codeline>
<codeline lineno="209"><highlight class="normal"></highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@__read_tcp_task.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="211" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab55d546556c0b8e39bd0f147765e233f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab01f2e382ae425e5bc2818772d059a56" kindref="member">__read_tcp_task</ref>(self,<sp/>read_tcp_task:<sp/>Task<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="212" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1feda3b6377035d969d4e21b4540ef14" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1feda3b6377035d969d4e21b4540ef14" kindref="member">__attr_read_tcp_task</ref>__attr_read_tcp_task<sp/>=<sp/>read_tcp_task</highlight></codeline>
<codeline lineno="213"><highlight class="normal"></highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@property</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="215" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e5e94d8da70d86c87eba78bcde9ff42" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e5e94d8da70d86c87eba78bcde9ff42" kindref="member">current_addr_connections</ref>(self)<sp/>-&gt;<sp/>set[str]:</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a87b7dc39e44da267c0eefd59d2b2672e" kindref="member">_attr_current_addr_connections</ref>_attr_current_addr_connections</highlight></codeline>
<codeline lineno="217"><highlight class="normal"></highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@current_addr_connections.setter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="219" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a5c2443c4a93b9bfedd207119b0dbb9bc" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e5e94d8da70d86c87eba78bcde9ff42" kindref="member">current_addr_connections</ref>(</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,<sp/>current_addr_connections:<sp/>set[str]</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a87b7dc39e44da267c0eefd59d2b2672e" kindref="member">_attr_current_addr_connections</ref>_attr_current_addr_connections<sp/>=<sp/>current_addr_connections</highlight></codeline>
<codeline lineno="223"><highlight class="normal"></highlight></codeline>
<codeline lineno="224" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a3510d32dbcb1a08fcd7796e2d8d2bdd6" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a3510d32dbcb1a08fcd7796e2d8d2bdd6" kindref="member">shutdown</ref>(self)<sp/>-&gt;<sp/>None:</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Close<sp/>sockets<sp/>and<sp/>Unbind<sp/>local<sp/>ports.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="226"><highlight class="normal"></highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa780e39d1ce443d422a41064cc382d1f" kindref="member">handle_connections_task_stop</ref>handle_connections_task_stop()</highlight></codeline>
<codeline lineno="228"><highlight class="normal"></highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp:</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Closing<sp/>TCP<sp/>port<sp/>3333&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a3510d32dbcb1a08fcd7796e2d8d2bdd6" kindref="member">shutdown</ref>(socket.SHUT_RDWR)</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp.close()</highlight></codeline>
<codeline lineno="234" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp<sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>(socket.herror,<sp/>socket.gaierror,<sp/>socket.timeout):</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight><highlight class="stringliteral">&quot;Error<sp/>on<sp/>closing<sp/>local<sp/>tcp<sp/>port<sp/>3333.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="238"><highlight class="normal"></highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp:</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Closing<sp/>UDP<sp/>port<sp/>2222&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp.close()</highlight></codeline>
<codeline lineno="243" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp<sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>(socket.herror,<sp/>socket.gaierror,<sp/>socket.timeout):</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight><highlight class="stringliteral">&quot;Error<sp/>on<sp/>closing<sp/>local<sp/>udp<sp/>port<sp/>2222.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="247"><highlight class="normal"></highlight></codeline>
<codeline lineno="248" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a28f05e11005dfc83e537f9e2e85f54d5" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a28f05e11005dfc83e537f9e2e85f54d5" kindref="member">bind_ports</ref>(self)<sp/>-&gt;<sp/>bool:</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;bind<sp/>ports.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="250"><highlight class="normal"></highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>server_address:<sp/>tuple[str,<sp/>int]</highlight></codeline>
<codeline lineno="252"><highlight class="normal"></highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):<sp/><sp/></highlight><highlight class="comment">#<sp/>or<sp/>self.udp._closed<sp/>or<sp/>self.udp.__getstate__()<sp/>==<sp/>-1:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp<sp/>=<sp/>socket.socket(socket.AF_INET,<sp/>socket.SOCK_DGRAM)</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp.setsockopt(socket.SOL_SOCKET,<sp/>socket.SO_BROADCAST,<sp/>1)</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp.setsockopt(socket.SOL_SOCKET,<sp/>socket.SO_REUSEADDR,<sp/>1)</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a159e60e3f78301ef89df33d9adaebbde" kindref="member">network_interface</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a6ef3ac8849218db44b014909d1f8146a" kindref="member">network_interface</ref>network_interface<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp.setsockopt(</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>socket.SOL_SOCKET,</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SO_BINDTODEVICE_LINUX,</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classstr" kindref="compound">str</ref>(self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a159e60e3f78301ef89df33d9adaebbde" kindref="member">network_interface</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a6ef3ac8849218db44b014909d1f8146a" kindref="member">network_interface</ref>network_interface<sp/>+<sp/></highlight><highlight class="stringliteral">&quot;\0&quot;</highlight><highlight class="normal">).encode(</highlight><highlight class="stringliteral">&quot;utf-8&quot;</highlight><highlight class="normal">),</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>server_address<sp/>=<sp/>(self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab8a8460610614f6230bbf346fc532269" kindref="member">server_ip</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aebdf9201096932f18c4f28e1e084d267" kindref="member">server_ip</ref>server_ip,<sp/>2222)</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp.bind(server_address)</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>(socket.herror,<sp/>socket.gaierror,<sp/>socket.timeout):</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Error<sp/>on<sp/>opening<sp/>and<sp/>binding<sp/>the<sp/>udp<sp/>port<sp/>2222<sp/>on<sp/>host&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>for<sp/>initiating<sp/>the<sp/>local<sp/>device<sp/>communication.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Bound<sp/>UDP<sp/>port<sp/>2222&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="276"><highlight class="normal"></highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp:<sp/><sp/></highlight><highlight class="comment">#<sp/>or<sp/>self.tcp.closed()<sp/>or<sp/>self.tcp.fileno()<sp/>==<sp/>-1:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp<sp/>=<sp/>socket.socket(socket.AF_INET,<sp/>socket.SOCK_STREAM)</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp.setsockopt(socket.SOL_SOCKET,<sp/>socket.SO_REUSEADDR,<sp/>1)</highlight></codeline>
<codeline lineno="280"><highlight class="normal"></highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a159e60e3f78301ef89df33d9adaebbde" kindref="member">network_interface</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a6ef3ac8849218db44b014909d1f8146a" kindref="member">network_interface</ref>network_interface<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp.setsockopt(</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>socket.SOL_SOCKET,</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SO_BINDTODEVICE_LINUX,</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classstr" kindref="compound">str</ref>(self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a159e60e3f78301ef89df33d9adaebbde" kindref="member">network_interface</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a6ef3ac8849218db44b014909d1f8146a" kindref="member">network_interface</ref>network_interface<sp/>+<sp/></highlight><highlight class="stringliteral">&quot;\0&quot;</highlight><highlight class="normal">).encode(</highlight><highlight class="stringliteral">&quot;utf-8&quot;</highlight><highlight class="normal">),</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>server_address<sp/>=<sp/>(</highlight><highlight class="stringliteral">&quot;0.0.0.0&quot;</highlight><highlight class="normal">,<sp/>3333)</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp.bind(server_address)</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>(socket.herror,<sp/>socket.gaierror,<sp/>socket.timeout):</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Error<sp/>on<sp/>opening<sp/>and<sp/>binding<sp/>the<sp/>tcp<sp/>port<sp/>3333<sp/>on<sp/>host&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>for<sp/>initiating<sp/>the<sp/>local<sp/>device<sp/>communication.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Bound<sp/>TCP<sp/>port<sp/>3333&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp.listen(1)</highlight></codeline>
<codeline lineno="299"><highlight class="normal"></highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="301"><highlight class="normal"></highlight></codeline>
<codeline lineno="302" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a4ce11db96280d000941a91cb37df2842" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a4ce11db96280d000941a91cb37df2842" kindref="member">process_device_identity_package</ref>(</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection:<sp/>TcpConnection,</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>data:<sp/>bytes,</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device_ref:<sp/>ReferencePass,</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>DeviceTcpReturn:</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Process<sp/>the<sp/>device<sp/>identity<sp/>package.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="309"><highlight class="normal"></highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Check<sp/>identification<sp/>package<sp/>from<sp/>device,<sp/>lock<sp/>the<sp/>device<sp/>object<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>changes,<sp/>safe<sp/>the<sp/>idenfication<sp/>to<sp/>device<sp/>object<sp/>if<sp/>it<sp/>is<sp/>a<sp/>not<sp/>known</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>device,<sp/>send<sp/>the<sp/>local<sp/>initial<sp/>vector<sp/>for<sp/>the<sp/>encrypted<sp/>communication</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>to<sp/>the<sp/>device.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="314"><highlight class="normal"></highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device:<sp/>Device<sp/>=<sp/>device_ref.ref</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log:<sp/>list</highlight></codeline>
<codeline lineno="317"><highlight class="normal"></highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Plain:<sp/>%s&quot;</highlight><highlight class="normal">,<sp/><ref refid="classstr" kindref="compound">str</ref>(data))</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>json_response:<sp/>dict[str,<sp/>Any]<sp/>=<sp/>json.loads(data)</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>identity:<sp/>ResponseIdentityMessage<sp/>=<sp/><ref refid="classklyqa__ctl_1_1devices_1_1response__identity__message_1_1ResponseIdentityMessage" kindref="compound">ResponseIdentityMessage</ref>(</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>**json_response[</highlight><highlight class="stringliteral">&quot;ident&quot;</highlight><highlight class="normal">]</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device.u_id<sp/>=<sp/>identity.unit_id</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>json.JSONDecodeError:</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>DeviceTcpReturn.NO_UNIT_ID</highlight></codeline>
<codeline lineno="327"><highlight class="normal"></highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>is_new_device:<sp/>bool<sp/>=<sp/></highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="329"><highlight class="normal"></highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>device.u_id<sp/>!=<sp/></highlight><highlight class="stringliteral">&quot;no_uid&quot;</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>device.u_id<sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a4d307f6bd0b66f3cb9fac3057fc87972" kindref="member">devices</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8d7418a9f89b4622dd814bd1c9ea4028" kindref="member">devices</ref>devices:</highlight></codeline>
<codeline lineno="331"><highlight class="normal"></highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>is_new_device<sp/>=<sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_dev:<sp/>Device<sp/>=<sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8f938ae53b3c24bbdc02f377671cf263" kindref="member">controller_data</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac7312a0c1fbe8ad9bcbd585e66e9e74c" kindref="member">controller_data</ref>controller_data.get_or_create_device(</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unit_id=identity.unit_id,<sp/>product_id=identity.product_id</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_dev.ident<sp/>=<sp/>identity</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>type(new_dev)<sp/><sp/></highlight><highlight class="comment">#<sp/>pylint:<sp/>disable=unidiomatic-typecheck</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>==<sp/>Device</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log<sp/>=<sp/>[</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Found<sp/>new<sp/>device<sp/>%s<sp/>but<sp/>don&apos;t<sp/>know<sp/>the<sp/>product<sp/>id<sp/>%s.&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>identity.unit_id,</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>identity.product_id,</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>]</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.info(*log)</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(*log)</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>is_new_device:</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log<sp/>=<sp/>[</highlight><highlight class="stringliteral">&quot;Found<sp/>new<sp/>device<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>identity.unit_id]</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.info(*log)</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(*log)</highlight></codeline>
<codeline lineno="353"><highlight class="normal"></highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>cached<sp/>client<sp/>device<sp/>(self.devices),<sp/>incoming<sp/>device<sp/>object<sp/>created</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>on<sp/>tcp<sp/>connection<sp/>acception</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>device.u_id<sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a4d307f6bd0b66f3cb9fac3057fc87972" kindref="member">devices</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8d7418a9f89b4622dd814bd1c9ea4028" kindref="member">devices</ref>devices:</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>DeviceTcpReturn.NOTHING_DONE</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device_repl:<sp/>Device<sp/>=<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a4d307f6bd0b66f3cb9fac3057fc87972" kindref="member">devices</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8d7418a9f89b4622dd814bd1c9ea4028" kindref="member">devices</ref>devices[device.u_id]</highlight></codeline>
<codeline lineno="359"><highlight class="normal"></highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>await<sp/>device_repl.use_lock():</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device_repl.local_addr<sp/>=<sp/>connection.address</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device<sp/>=<sp/>device_repl</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device_ref.ref<sp/>=<sp/>device_repl</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>err:<sp/>str<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;{task_name()}<sp/>-<sp/>Couldn&apos;t<sp/>get<sp/>use<sp/>lock<sp/>for<sp/>device&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;<sp/>{device_repl.get_name()}<sp/>{connection.address})&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(err)</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>DeviceTcpReturn.DEVICE_LOCK_TIMEOUT</highlight></codeline>
<codeline lineno="371"><highlight class="normal"></highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.received_packages.append(json_response)</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device.save_device_message(json_response)</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device.local_con<sp/>=<sp/>self</highlight></codeline>
<codeline lineno="375"><highlight class="normal"></highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device.u_id<sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">or</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue[device.u_id]</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>device.u_id<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue:</highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>del<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue[device.u_id]</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>DeviceTcpReturn.NO_MESSAGE_TO_SEND</highlight></codeline>
<codeline lineno="383"><highlight class="normal"></highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>is_new_device<sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>device.ident:</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a9df3b50dfc0fcc7c8ec991bb9be9c5ba" kindref="member">task_log</ref>(f</highlight><highlight class="stringliteral">&quot;Found<sp/>device<sp/>{device.ident.unit_id}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loop:<sp/>asyncio.AbstractEventLoop<sp/>=<sp/>asyncio.get_event_loop()</highlight></codeline>
<codeline lineno="387"><highlight class="normal"></highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;all&quot;</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8f938ae53b3c24bbdc02f377671cf263" kindref="member">controller_data</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac7312a0c1fbe8ad9bcbd585e66e9e74c" kindref="member">controller_data</ref>controller_data.aes_keys:</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.aes_key<sp/>=<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8f938ae53b3c24bbdc02f377671cf263" kindref="member">controller_data</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac7312a0c1fbe8ad9bcbd585e66e9e74c" kindref="member">controller_data</ref>controller_data.aes_keys[</highlight><highlight class="stringliteral">&quot;all&quot;</highlight><highlight class="normal">]</highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">elif</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>isinstance(self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8f938ae53b3c24bbdc02f377671cf263" kindref="member">controller_data</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac7312a0c1fbe8ad9bcbd585e66e9e74c" kindref="member">controller_data</ref>controller_data.aes_keys,<sp/>dict)</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>device.u_id<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8f938ae53b3c24bbdc02f377671cf263" kindref="member">controller_data</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac7312a0c1fbe8ad9bcbd585e66e9e74c" kindref="member">controller_data</ref>controller_data.aes_keys</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.aes_key<sp/>=<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8f938ae53b3c24bbdc02f377671cf263" kindref="member">controller_data</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac7312a0c1fbe8ad9bcbd585e66e9e74c" kindref="member">controller_data</ref>controller_data.aes_keys[device.u_id]</highlight></codeline>
<codeline lineno="395"><highlight class="normal"></highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>connection.socket<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Sending<sp/>local<sp/>initial<sp/>vector.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>iv_data:<sp/>bytes<sp/>=<sp/>DataPackage.create(</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.local_iv,<sp/>PackageType.IV</highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>).serialize()</highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>loop.sock_sendall(connection.socket,<sp/>iv_data)</highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>socket.error:</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>DeviceTcpReturn.SOCKET_ERROR</highlight></codeline>
<codeline lineno="405"><highlight class="normal"></highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>DeviceTcpReturn.NO_ERROR</highlight></codeline>
<codeline lineno="407"><highlight class="normal"></highlight></codeline>
<codeline lineno="408" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ad1b4bfaedd513acfccbf1b12e36d5469" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ad1b4bfaedd513acfccbf1b12e36d5469" kindref="member">process_aes_initial_vector_package</ref>(</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,<sp/>connection:<sp/>TcpConnection,<sp/>data:<sp/>bytes,<sp/>device:<sp/>Device</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>DeviceTcpReturn:</highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Create<sp/>the<sp/>AES<sp/>encryption<sp/>and<sp/>decryption<sp/>objects.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="412"><highlight class="normal"></highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.remote_iv<sp/>=<sp/>data</highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.received_packages.append(data)</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>connection.aes_key:</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a9df3b50dfc0fcc7c8ec991bb9be9c5ba" kindref="member">task_log</ref>(</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Missing<sp/>AES<sp/>key.<sp/>Probably<sp/>not<sp/>in<sp/>onboarded<sp/>devices.<sp/>Provide&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>AES<sp/>key<sp/>with<sp/>--aes<sp/>[key]!<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>+<sp/><ref refid="classstr" kindref="compound">str</ref>(device.u_id)</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>DeviceTcpReturn.MISSING_AES_KEY</highlight></codeline>
<codeline lineno="422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.sending_aes<sp/>=<sp/>AES.new(</highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.aes_key,</highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AES.MODE_CBC,</highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>iv=connection.local_iv<sp/>+<sp/>connection.remote_iv,</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.receiving_aes<sp/>=<sp/>AES.new(</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.aes_key,</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AES.MODE_CBC,</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>iv=connection.remote_iv<sp/>+<sp/>connection.local_iv,</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="432"><highlight class="normal"></highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.state<sp/>=<sp/>AesConnectionState.CONNECTED</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Received<sp/>remote<sp/>initial<sp/>vector.<sp/>Connected<sp/>state.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="435"><highlight class="normal"></highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>DeviceTcpReturn.NO_ERROR</highlight></codeline>
<codeline lineno="437"><highlight class="normal"></highlight></codeline>
<codeline lineno="438" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a46f68728bc59f0e5991bc390f67f2685" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a46f68728bc59f0e5991bc390f67f2685" kindref="member">process_message_answer_package</ref>(</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection:<sp/>TcpConnection,</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>answer:<sp/>bytes,</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device:<sp/>Device,</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent:<sp/>Message<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>DeviceTcpReturn:</highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Process<sp/>the<sp/>encrypted<sp/>device<sp/>answer.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="446"><highlight class="normal"></highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_val:<sp/>DeviceTcpReturn<sp/>=<sp/>DeviceTcpReturn.NO_ERROR</highlight></codeline>
<codeline lineno="448"><highlight class="normal"></highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cipher:<sp/>bytes<sp/>=<sp/>answer</highlight></codeline>
<codeline lineno="450"><highlight class="normal"></highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>plain:<sp/>bytes<sp/>=<sp/>connection.receiving_aes.decrypt(cipher)</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.received_packages.append(plain)</highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>msg_sent.state<sp/>==<sp/>MessageState.ANSWERED</highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent.answer<sp/>=<sp/>plain</highlight></codeline>
<codeline lineno="458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>json_response:<sp/>TypeJson<sp/>=<sp/>{}</highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>plain_utf8:<sp/>str<sp/>=<sp/>plain.decode()</highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>json_response<sp/>=<sp/>json.loads(plain_utf8)</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device.save_device_message(json_response)</highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.sent_msg_answer<sp/>=<sp/>json_response</highlight></codeline>
<codeline lineno="464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.aes_key_confirmed<sp/>=<sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a9df3b50dfc0fcc7c8ec991bb9be9c5ba" kindref="member">task_log</ref>(</highlight></codeline>
<codeline lineno="466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;device<sp/>uid<sp/>{device.u_id}<sp/>aes_confirmed&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;<sp/>{connection.aes_key_confirmed}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>json.JSONDecodeError:</highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a9df3b50dfc0fcc7c8ec991bb9be9c5ba" kindref="member">task_log</ref>(</highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>load<sp/>json<sp/>message<sp/>from<sp/>device:<sp/>&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Couldn&apos;t<sp/>read<sp/>answer<sp/>from<sp/>device<sp/>%s!&quot;</highlight><highlight class="normal">,<sp/>device.u_id</highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;%s&quot;</highlight><highlight class="normal">,<sp/><ref refid="classstr" kindref="compound">str</ref>(answer))</highlight></codeline>
<codeline lineno="475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>DeviceTcpReturn.RESPONSE_ERROR</highlight></codeline>
<codeline lineno="476"><highlight class="normal"></highlight></codeline>
<codeline lineno="477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent.answer_utf8<sp/>=<sp/>plain_utf8</highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent.answer_json<sp/>=<sp/>json_response</highlight></codeline>
<codeline lineno="479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent.state<sp/>=<sp/>MessageState.ANSWERED</highlight></codeline>
<codeline lineno="480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent.answered_datetime<sp/>=<sp/>datetime.datetime.now()</highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_val<sp/>=<sp/>DeviceTcpReturn.ANSWERED</highlight></codeline>
<codeline lineno="482"><highlight class="normal"></highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent</highlight></codeline>
<codeline lineno="485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>msg_sent.callback<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>device<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>msg_sent.callback(msg_sent,<sp/>device.u_id)</highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;device<sp/>{device.u_id}<sp/>answered<sp/>msg<sp/>{msg_sent.msg_queue}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="492"><highlight class="normal"></highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;%s<sp/>Request&apos;s<sp/>reply<sp/>decrypted:<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/><ref refid="classstr" kindref="compound">str</ref>(plain),</highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device.u_id<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>device<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>return_val</highlight></codeline>
<codeline lineno="498"><highlight class="normal"></highlight></codeline>
<codeline lineno="499" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a34b95b45332382bb830a3f1277878268" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a34b95b45332382bb830a3f1277878268" kindref="member">remove_msg_from_queue</ref>(</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,<sp/>msg:<sp/>Message,<sp/>device:<sp/>Device<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Remove<sp/>message<sp/>from<sp/>message<sp/>queue.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="503"><highlight class="normal"></highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>device:</highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>msg<sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue[device.u_id]:</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="508"><highlight class="normal"></highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a9df3b50dfc0fcc7c8ec991bb9be9c5ba" kindref="member">task_log</ref>(</highlight><highlight class="stringliteral">&quot;remove<sp/>message<sp/>from<sp/>queue&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue[device.u_id].remove(msg)</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>msg.state<sp/>=<sp/>MessageState.SENT</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="512"><highlight class="normal"></highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device.u_id<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue</highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue[device.u_id]</highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>del<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue[device.u_id]</highlight></codeline>
<codeline lineno="518"><highlight class="normal"></highlight></codeline>
<codeline lineno="519" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a900e05554022ee9ecb3ba5621369016d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a900e05554022ee9ecb3ba5621369016d" kindref="member">handle_connection</ref>(</highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device_ref:<sp/>ReferencePass,</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection:<sp/>TcpConnection,</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent_r:<sp/>ReferencePass,</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>DeviceTcpReturn:</highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="526"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Make<sp/>AES<sp/>handshake.</highlight></codeline>
<codeline lineno="527"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Getting<sp/>the<sp/>identity<sp/>of<sp/>the<sp/>device.</highlight></codeline>
<codeline lineno="528"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Send<sp/>the<sp/>commands<sp/>in<sp/>message<sp/>queue<sp/>to<sp/>the<sp/>device<sp/>with<sp/>the<sp/>device<sp/>u_id</highlight></codeline>
<codeline lineno="529"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>or<sp/>to<sp/>any<sp/>device.</highlight></codeline>
<codeline lineno="530"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="531"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Params:</highlight></codeline>
<codeline lineno="532"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device:<sp/>Device<sp/>reference<sp/>-<sp/>(initial)<sp/>device<sp/>object<sp/>with<sp/>the<sp/>tcp</highlight></codeline>
<codeline lineno="533"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection</highlight></codeline>
<codeline lineno="534"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection<sp/>-<sp/>TCP<sp/>connection<sp/>tunnel<sp/>to<sp/>the<sp/>device</highlight></codeline>
<codeline lineno="535"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent_r<sp/>-<sp/>Message<sp/>reference<sp/>object<sp/>to<sp/>send</highlight></codeline>
<codeline lineno="536"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="537"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Returns:<sp/>DeviceTcpReturn</highlight></codeline>
<codeline lineno="538"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="539"><highlight class="normal"></highlight></codeline>
<codeline lineno="540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device:<sp/>Device<sp/>=<sp/>device_ref.ref</highlight></codeline>
<codeline lineno="541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>device<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">or</highlight><highlight class="normal"><sp/>connection.socket<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>DeviceTcpReturn.UNKNOWN_ERROR</highlight></codeline>
<codeline lineno="543"><highlight class="normal"></highlight></codeline>
<codeline lineno="544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>data:<sp/>bytes<sp/>=<sp/>b</highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_send:<sp/>datetime.datetime<sp/>=<sp/>datetime.datetime.now()</highlight></codeline>
<codeline lineno="546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pause:<sp/>datetime.timedelta<sp/>=<sp/>datetime.timedelta(milliseconds=0)</highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elapsed:<sp/>datetime.timedelta<sp/>=<sp/>datetime.datetime.now()<sp/>-<sp/>last_send</highlight></codeline>
<codeline lineno="548"><highlight class="normal"></highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_val:<sp/>DeviceTcpReturn<sp/>=<sp/>DeviceTcpReturn.NOTHING_DONE</highlight></codeline>
<codeline lineno="550"><highlight class="normal"></highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>communication_finished:<sp/>bool<sp/>=<sp/></highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="552"><highlight class="normal"></highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal">__send_next_msg()<sp/>-&gt;<sp/>None:</highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nonlocal<sp/>last_send,<sp/>pause,<sp/>return_val,<sp/>device,<sp/>msg_sent_r</highlight></codeline>
<codeline lineno="555"><highlight class="normal"></highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>send_next:<sp/>bool<sp/>=<sp/>elapsed<sp/>&gt;=<sp/>pause</highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sleep:<sp/>float<sp/>=<sp/>(pause<sp/>-<sp/>elapsed).total_seconds()</highlight></codeline>
<codeline lineno="558"><highlight class="normal"></highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>sleep<sp/>&gt;<sp/>0:</highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>asyncio.sleep(sleep)</highlight></codeline>
<codeline lineno="561"><highlight class="normal"></highlight></codeline>
<codeline lineno="562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>send_next<sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>device:</highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg:<sp/>Message<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>msg</highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>device.u_id<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue</highlight></codeline>
<codeline lineno="567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>len(self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue[device.u_id])<sp/>&gt;<sp/>0</highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg<sp/>=<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue[device.u_id][0]</highlight></codeline>
<codeline lineno="570"><highlight class="normal"></highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>msg:</highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a9df3b50dfc0fcc7c8ec991bb9be9c5ba" kindref="member">task_log</ref>(</highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;Process<sp/>msg<sp/>to<sp/>send<sp/>&apos;{msg.msg_queue}&apos;<sp/>to<sp/>device&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;<sp/>&apos;{device.u_id}&apos;.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>j:<sp/>int<sp/>=<sp/>0</highlight></codeline>
<codeline lineno="577"><highlight class="normal"></highlight></codeline>
<codeline lineno="578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>msg.state<sp/>==<sp/>MessageState.UNSENT:</highlight></codeline>
<codeline lineno="579"><highlight class="normal"></highlight></codeline>
<codeline lineno="580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>j<sp/>&lt;<sp/>len(msg.msg_queue):</highlight></codeline>
<codeline lineno="581"><highlight class="normal"></highlight></codeline>
<codeline lineno="582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>command:<sp/>Command<sp/>=<sp/>msg.msg_queue[j]</highlight></codeline>
<codeline lineno="583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>text:<sp/>str<sp/>=<sp/>command.msg_str()</highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>isinstance(command,<sp/>CommandWithCheckValues):</highlight></codeline>
<codeline lineno="585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cwcv:<sp/>CommandWithCheckValues<sp/>=<sp/>command</highlight></codeline>
<codeline lineno="586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>cwcv._force<sp/><sp/></highlight><highlight class="comment">#<sp/>pylint:<sp/>disable=protected-access</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>cwcv.check_values(device=device)</highlight></codeline>
<codeline lineno="589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a34b95b45332382bb830a3f1277878268" kindref="member">remove_msg_from_queue</ref>remove_msg_from_queue(msg,<sp/>device)</highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="592"><highlight class="normal"></highlight></codeline>
<codeline lineno="593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>isinstance(command,<sp/>TransitionCommand):</highlight></codeline>
<codeline lineno="594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tc:<sp/>TransitionCommand<sp/>=<sp/>command</highlight></codeline>
<codeline lineno="595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pause<sp/>=<sp/>datetime.timedelta(</highlight></codeline>
<codeline lineno="596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>milliseconds=<ref refid="namespaceklyqa__ctl_1_1general_1_1general_1acc51622ce1f8c7a6b4f56f70f907ae40" kindref="member">float</ref>(tc.transition_time)</highlight></codeline>
<codeline lineno="597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="598"><highlight class="normal"></highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>await<sp/>connection.encrypt_and_send_msg(</highlight></codeline>
<codeline lineno="601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>text,<sp/>device</highlight></codeline>
<codeline lineno="602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="603"><highlight class="normal"></highlight></codeline>
<codeline lineno="604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_val<sp/>=<sp/>DeviceTcpReturn.SENT</highlight></codeline>
<codeline lineno="605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>isinstance(msg,<sp/>BroadCastMessage):</highlight></codeline>
<codeline lineno="606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bcm:<sp/>BroadCastMessage<sp/>=<sp/>msg</highlight></codeline>
<codeline lineno="607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bcm.sent_to_uids.add(device.u_id)</highlight></codeline>
<codeline lineno="608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent_r.ref<sp/>=<sp/>msg</highlight></codeline>
<codeline lineno="609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_send<sp/>=<sp/>datetime.datetime.now()</highlight></codeline>
<codeline lineno="610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>j<sp/>=<sp/>j<sp/>+<sp/>1</highlight></codeline>
<codeline lineno="611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg.msg_queue_sent.append(text)</highlight></codeline>
<codeline lineno="612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>don&apos;t<sp/>process<sp/>the<sp/>next<sp/>message,<sp/>but<sp/>if</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="613"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>still<sp/>elements<sp/>in<sp/>the<sp/>msg_queue<sp/>send</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="614"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>them<sp/>as<sp/>well</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>send_next<sp/>=<sp/></highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>break</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>send<sp/>message!&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_val<sp/>=<sp/>DeviceTcpReturn.SEND_ERROR</highlight></codeline>
<codeline lineno="620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>socket.error:</highlight></codeline>
<codeline lineno="622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight></codeline>
<codeline lineno="623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Socket<sp/>error<sp/>while<sp/>trying<sp/>to<sp/>send&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>message!&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_val<sp/>=<sp/>DeviceTcpReturn.SEND_ERROR</highlight></codeline>
<codeline lineno="628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="629"><highlight class="normal"></highlight></codeline>
<codeline lineno="630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>len(msg.msg_queue)<sp/>==<sp/>len(msg.msg_queue_sent):</highlight></codeline>
<codeline lineno="631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg.state<sp/>=<sp/>MessageState.SENT</highlight></codeline>
<codeline lineno="632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>all<sp/>messages<sp/>,<sp/>break<sp/>now<sp/>for<sp/>reading<sp/>response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a34b95b45332382bb830a3f1277878268" kindref="member">remove_msg_from_queue</ref>remove_msg_from_queue(msg,<sp/>device)</highlight></codeline>
<codeline lineno="634"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a34b95b45332382bb830a3f1277878268" kindref="member">remove_msg_from_queue</ref>remove_msg_from_queue(msg,<sp/>device)</highlight></codeline>
<codeline lineno="636"><highlight class="normal"></highlight></codeline>
<codeline lineno="637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>msg_sent_r.ref<sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>msg_sent_r.ref.state<sp/>==<sp/>MessageState.ANSWERED:</highlight></codeline>
<codeline lineno="638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent_r.ref<sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="639"><highlight class="normal"></highlight></codeline>
<codeline lineno="640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>communication_finished<sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device.u_id<sp/>==<sp/></highlight><highlight class="stringliteral">&quot;no_uid&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">or</highlight><highlight class="normal"><sp/>type(device)<sp/>==<sp/>Device<sp/><sp/></highlight><highlight class="comment">#<sp/>pylint:<sp/>disable=unidiomatic-typecheck</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">or</highlight><highlight class="normal"><sp/>device.u_id<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue</highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">or</highlight><highlight class="normal"><sp/>msg_sent_r.ref</highlight></codeline>
<codeline lineno="645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="646"><highlight class="normal"></highlight></codeline>
<codeline lineno="647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent_r.ref</highlight></codeline>
<codeline lineno="649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>msg_sent_r.ref.state<sp/>==<sp/>MessageState.ANSWERED</highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent_r.ref<sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="652"><highlight class="normal"></highlight></codeline>
<codeline lineno="653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.state<sp/>==<sp/>AesConnectionState.CONNECTED</highlight></codeline>
<codeline lineno="655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>msg_sent_r.ref<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>__send_next_msg()</highlight></codeline>
<codeline lineno="658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>return_val<sp/>==<sp/>DeviceTcpReturn.SEND_ERROR:</highlight></codeline>
<codeline lineno="659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>return_val</highlight></codeline>
<codeline lineno="660"><highlight class="normal"></highlight></codeline>
<codeline lineno="661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>data_ref:<sp/>ReferencePass<sp/>=<sp/><ref refid="classklyqa__ctl_1_1general_1_1general_1_1ReferencePass" kindref="compound">ReferencePass</ref>(data)</highlight></codeline>
<codeline lineno="662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>read_data_ret:<sp/>DeviceTcpReturn<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>connection.read_local_tcp_socket(data_ref)</highlight></codeline>
<codeline lineno="664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>read_data_ret<sp/>!=<sp/>DeviceTcpReturn.NO_ERROR:</highlight></codeline>
<codeline lineno="666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>read_data_ret</highlight></codeline>
<codeline lineno="667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>data<sp/>=<sp/>data_ref.ref</highlight></codeline>
<codeline lineno="668"><highlight class="normal"></highlight></codeline>
<codeline lineno="669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elapsed<sp/>=<sp/>datetime.datetime.now()<sp/>-<sp/>last_send</highlight></codeline>
<codeline lineno="670"><highlight class="normal"></highlight></codeline>
<codeline lineno="671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>communication_finished<sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>(len(data)):</highlight></codeline>
<codeline lineno="672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a9df3b50dfc0fcc7c8ec991bb9be9c5ba" kindref="member">task_log</ref>(</highlight></codeline>
<codeline lineno="673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;TCP<sp/>server<sp/>received<sp/>{str(len(data))}<sp/>bytes<sp/>from&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;<sp/>{str(connection.address)}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="676"><highlight class="normal"></highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_val<sp/>=<sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aaa28266e241c2e30e8acd468fab06fde" kindref="member">process_tcp_package</ref>process_tcp_package(</highlight></codeline>
<codeline lineno="678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection,<sp/>data_ref,<sp/>msg_sent_r.ref,<sp/>device_ref</highlight></codeline>
<codeline lineno="679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>data<sp/>=<sp/>data_ref.ref</highlight></codeline>
<codeline lineno="681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device<sp/>=<sp/>device_ref.ref</highlight></codeline>
<codeline lineno="682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>return_val<sp/>==<sp/>DeviceTcpReturn.ANSWERED:</highlight></codeline>
<codeline lineno="683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent_r.ref<sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>communication_finished<sp/>=<sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">elif</highlight><highlight class="normal"><sp/>return_val<sp/>!=<sp/>DeviceTcpReturn.NO_ERROR:</highlight></codeline>
<codeline lineno="686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>return_val</highlight></codeline>
<codeline lineno="687"><highlight class="normal"></highlight></codeline>
<codeline lineno="688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>return_val</highlight></codeline>
<codeline lineno="689"><highlight class="normal"></highlight></codeline>
<codeline lineno="690" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aaa28266e241c2e30e8acd468fab06fde" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aaa28266e241c2e30e8acd468fab06fde" kindref="member">process_tcp_package</ref>(</highlight></codeline>
<codeline lineno="691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection:<sp/>TcpConnection,</highlight></codeline>
<codeline lineno="693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>data_ref:<sp/>ReferencePass,</highlight></codeline>
<codeline lineno="694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent:<sp/>Message<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device_ref:<sp/>ReferencePass,</highlight></codeline>
<codeline lineno="696"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>DeviceTcpReturn:</highlight></codeline>
<codeline lineno="697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Read<sp/>tcp<sp/>socket<sp/>and<sp/>process<sp/>packages.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="698"><highlight class="normal"></highlight></codeline>
<codeline lineno="699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_val:<sp/>DeviceTcpReturn<sp/>=<sp/>DeviceTcpReturn.NO_ERROR</highlight></codeline>
<codeline lineno="700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package:<sp/>DataPackage<sp/>=<sp/>DataPackage.deserialize(data_ref.ref)</highlight></codeline>
<codeline lineno="702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>PackageException:</highlight></codeline>
<codeline lineno="703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>DeviceTcpReturn.RESPONSE_ERROR</highlight></codeline>
<codeline lineno="704"><highlight class="normal"></highlight></codeline>
<codeline lineno="705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>data_ref.ref<sp/>=<sp/>data_ref.ref[4<sp/>+<sp/>package.length<sp/>:]</highlight></codeline>
<codeline lineno="706"><highlight class="normal"></highlight></codeline>
<codeline lineno="707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.state<sp/>==<sp/>AesConnectionState.WAIT_IV</highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>package.ptype<sp/>==<sp/>PackageType.PLAIN</highlight></codeline>
<codeline lineno="710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="711"><highlight class="normal"></highlight></codeline>
<codeline lineno="712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_val<sp/>=<sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a4ce11db96280d000941a91cb37df2842" kindref="member">process_device_identity_package</ref>process_device_identity_package(</highlight></codeline>
<codeline lineno="713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection,<sp/>package.data,<sp/>device_ref</highlight></codeline>
<codeline lineno="714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>return_val<sp/>!=<sp/>DeviceTcpReturn.NO_ERROR:</highlight></codeline>
<codeline lineno="716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>return_val</highlight></codeline>
<codeline lineno="717"><highlight class="normal"></highlight></codeline>
<codeline lineno="718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.state<sp/>==<sp/>AesConnectionState.WAIT_IV</highlight></codeline>
<codeline lineno="720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>package.ptype<sp/>==<sp/>PackageType.IV</highlight></codeline>
<codeline lineno="721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_val<sp/>=<sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ad1b4bfaedd513acfccbf1b12e36d5469" kindref="member">process_aes_initial_vector_package</ref>process_aes_initial_vector_package(</highlight></codeline>
<codeline lineno="723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection,<sp/>package.data,<sp/>device_ref.ref</highlight></codeline>
<codeline lineno="724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>return_val<sp/>!=<sp/>DeviceTcpReturn.NO_ERROR:</highlight></codeline>
<codeline lineno="726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>return_val</highlight></codeline>
<codeline lineno="727"><highlight class="normal"></highlight></codeline>
<codeline lineno="728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">elif</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="729"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.state<sp/>==<sp/>AesConnectionState.CONNECTED</highlight></codeline>
<codeline lineno="730"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>package.ptype<sp/>==<sp/>PackageType.ENC</highlight></codeline>
<codeline lineno="731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_val<sp/>=<sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a46f68728bc59f0e5991bc390f67f2685" kindref="member">process_message_answer_package</ref>process_message_answer_package(</highlight></codeline>
<codeline lineno="733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection,<sp/>package.data,<sp/>device_ref.ref,<sp/>msg_sent</highlight></codeline>
<codeline lineno="734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a9df3b50dfc0fcc7c8ec991bb9be9c5ba" kindref="member">task_log</ref>(</highlight></codeline>
<codeline lineno="737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;No<sp/>answer<sp/>to<sp/>process.<sp/>Waiting<sp/>on<sp/>answer<sp/>of<sp/>the<sp/>device<sp/>...<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="739"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>return_val</highlight></codeline>
<codeline lineno="740"><highlight class="normal"></highlight></codeline>
<codeline lineno="741" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0b582d0bf1523d1d0404867ab921539f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0b582d0bf1523d1d0404867ab921539f" kindref="member">device_handle_local_tcp</ref>(</highlight></codeline>
<codeline lineno="742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,<sp/>device:<sp/>Device,<sp/>connection:<sp/>TcpConnection</highlight></codeline>
<codeline lineno="743"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>DeviceTcpReturn:</highlight></codeline>
<codeline lineno="744"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Handle<sp/>the<sp/>incoming<sp/>tcp<sp/>connection<sp/>to<sp/>the<sp/>device.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="745"><highlight class="normal"></highlight></codeline>
<codeline lineno="746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_state:<sp/>DeviceTcpReturn<sp/>=<sp/>DeviceTcpReturn.NOTHING_DONE</highlight></codeline>
<codeline lineno="747"><highlight class="normal"></highlight></codeline>
<codeline lineno="748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r_device:<sp/>ReferencePass<sp/>=<sp/><ref refid="classklyqa__ctl_1_1general_1_1general_1_1ReferencePass" kindref="compound">ReferencePass</ref>(device)</highlight></codeline>
<codeline lineno="750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent_ref:<sp/>ReferencePass<sp/>=<sp/><ref refid="classklyqa__ctl_1_1general_1_1general_1_1ReferencePass" kindref="compound">ReferencePass</ref>(</highlight><highlight class="keywordtype">None</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="751"><highlight class="normal"></highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight></codeline>
<codeline lineno="753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;New<sp/>tcp<sp/>connection<sp/>to<sp/>device<sp/>at<sp/>{connection.address}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_state<sp/>=<sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a900e05554022ee9ecb3ba5621369016d" kindref="member">handle_connection</ref>handle_connection(</highlight></codeline>
<codeline lineno="757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>r_device,<sp/>connection=connection,<sp/>msg_sent_r=msg_sent_ref</highlight></codeline>
<codeline lineno="758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>CancelledError:</highlight></codeline>
<codeline lineno="760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight></codeline>
<codeline lineno="761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;Cancelled<sp/>local<sp/>send<sp/>to<sp/>{connection.address[&apos;ip&apos;]}!&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>exception:</highlight></codeline>
<codeline lineno="764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1abab49b300927a080244615ee3ab494e3" kindref="member">task_log_error</ref>(</highlight></codeline>
<codeline lineno="766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Unhandled<sp/>exception<sp/>during<sp/>local<sp/>communication!<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="767"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>+<sp/><ref refid="classstr" kindref="compound">str</ref>(type(exception))</highlight></codeline>
<codeline lineno="768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent_ref.ref.exception<sp/>=<sp/>exception</highlight></codeline>
<codeline lineno="770"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">finally</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device<sp/>=<sp/>r_device.ref</highlight></codeline>
<codeline lineno="772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>connection.socket<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.socket.shutdown(socket.SHUT_RDWR)</highlight></codeline>
<codeline lineno="775"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.socket.close()</highlight></codeline>
<codeline lineno="776"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">finally</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="777"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.socket<sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="778"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e5e94d8da70d86c87eba78bcde9ff42" kindref="member">current_addr_connections</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a5c2443c4a93b9bfedd207119b0dbb9bc" kindref="member">current_addr_connections</ref>current_addr_connections.remove(</highlight></codeline>
<codeline lineno="779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classstr" kindref="compound">str</ref>(connection.address[</highlight><highlight class="stringliteral">&quot;ip&quot;</highlight><highlight class="normal">])</highlight></codeline>
<codeline lineno="780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="781"><highlight class="normal"></highlight></codeline>
<codeline lineno="782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unit_id:<sp/>str<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;<sp/>Unit-ID:<sp/>{device.u_id}&quot;</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>device.u_id<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="785"><highlight class="normal"></highlight></codeline>
<codeline lineno="786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>if<sp/>return_state<sp/>not<sp/>in<sp/>[</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="787"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>DeviceTcpReturn.SENT,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="788"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>DeviceTcpReturn.ANSWERED,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>]:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="790"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>return_state<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>[</highlight></codeline>
<codeline lineno="791"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DeviceTcpReturn.TCP_SOCKET_CLOSED_UNEXPECTEDLY</highlight></codeline>
<codeline lineno="792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>]:</highlight></codeline>
<codeline lineno="793"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Something<sp/>bad<sp/>could<sp/>have<sp/>happened<sp/>with<sp/>the<sp/>device.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="794"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Remove<sp/>the<sp/>message<sp/>precautiously<sp/>from<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="795"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>message<sp/>queue.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="796"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_sent:<sp/>Message<sp/>=<sp/>msg_sent_ref.ref</highlight></codeline>
<codeline lineno="797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>msg_sent:</highlight></codeline>
<codeline lineno="798"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>msg_sent.call_cb()</highlight></codeline>
<codeline lineno="799"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a34b95b45332382bb830a3f1277878268" kindref="member">remove_msg_from_queue</ref>remove_msg_from_queue(msg_sent,<sp/>device)</highlight></codeline>
<codeline lineno="800"><highlight class="normal"></highlight></codeline>
<codeline lineno="801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/><ref refid="classstr" kindref="compound">str</ref>(device.u_id)<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a4d307f6bd0b66f3cb9fac3057fc87972" kindref="member">devices</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8d7418a9f89b4622dd814bd1c9ea4028" kindref="member">devices</ref>devices:</highlight></codeline>
<codeline lineno="802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device_b:<sp/>Device<sp/>=<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a4d307f6bd0b66f3cb9fac3057fc87972" kindref="member">devices</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8d7418a9f89b4622dd814bd1c9ea4028" kindref="member">devices</ref>devices[device.u_id]</highlight></codeline>
<codeline lineno="803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device_b.use_unlock()</highlight></codeline>
<codeline lineno="804"><highlight class="normal"></highlight></codeline>
<codeline lineno="805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">elif</highlight><highlight class="normal"><sp/>return_state<sp/>==<sp/>DeviceTcpReturn.UNKNOWN_ERROR:</highlight></codeline>
<codeline lineno="806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight></codeline>
<codeline lineno="807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Unknown<sp/>error<sp/>during<sp/>send<sp/>(and<sp/>handshake)<sp/>with<sp/>device&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;<sp/>{unit_id}.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="810"><highlight class="normal"></highlight></codeline>
<codeline lineno="811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a9df3b50dfc0fcc7c8ec991bb9be9c5ba" kindref="member">task_log</ref>(</highlight></codeline>
<codeline lineno="812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Finished<sp/>tcp<sp/>connection<sp/>to<sp/>device&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;<sp/>{connection.address[&apos;ip&apos;]}<sp/>with<sp/>return<sp/>state:&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;<sp/>{return_state}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="816"><highlight class="normal"></highlight></codeline>
<codeline lineno="817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>CancelledError:</highlight></codeline>
<codeline lineno="818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1abab49b300927a080244615ee3ab494e3" kindref="member">task_log_error</ref>(</highlight><highlight class="stringliteral">&quot;Device<sp/>tcp<sp/>task<sp/>cancelled.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception:</highlight></codeline>
<codeline lineno="820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>return_state</highlight></codeline>
<codeline lineno="822"><highlight class="normal"></highlight></codeline>
<codeline lineno="823" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a69a2aabf1a7bc94f925f914df5ceae10" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a69a2aabf1a7bc94f925f914df5ceae10" kindref="member">send_udp_broadcast</ref>(self)<sp/>-&gt;<sp/>bool:</highlight></codeline>
<codeline lineno="824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Send<sp/>qcx-syn<sp/>broadcast<sp/>on<sp/>udp<sp/>socket.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="825"><highlight class="normal"></highlight></codeline>
<codeline lineno="826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loop:<sp/>AbstractEventLoop<sp/>=<sp/>asyncio.get_event_loop()</highlight></codeline>
<codeline lineno="827"><highlight class="normal"></highlight></codeline>
<codeline lineno="828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Broadcasting<sp/>QCX-SYN<sp/>Burst&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp:</highlight></codeline>
<codeline lineno="831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>loop.sock_sendto<sp/>python3.11+</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>loop.run_in_executor(</highlight></codeline>
<codeline lineno="833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp.sendto,</highlight></codeline>
<codeline lineno="835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;QCX-SYN&quot;</highlight><highlight class="normal">.encode(</highlight><highlight class="stringliteral">&quot;utf-8&quot;</highlight><highlight class="normal">),</highlight></codeline>
<codeline lineno="836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="stringliteral">&quot;255.255.255.255&quot;</highlight><highlight class="normal">,<sp/>2222),</highlight></codeline>
<codeline lineno="837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="840"><highlight class="normal"></highlight></codeline>
<codeline lineno="841"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>socket.error:</highlight></codeline>
<codeline lineno="842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Broadcasting<sp/>QCX-SYN<sp/>Burst<sp/>Exception&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="844"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a28f05e11005dfc83e537f9e2e85f54d5" kindref="member">bind_ports</ref>bind_ports():</highlight></codeline>
<codeline lineno="845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight><highlight class="stringliteral">&quot;Error<sp/>binding<sp/>ports<sp/>udp<sp/>2222<sp/>and<sp/>tcp<sp/>3333.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="848"><highlight class="normal"></highlight></codeline>
<codeline lineno="849" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aed3640a60ff23b9532ca91ebd2a9d01a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aed3640a60ff23b9532ca91ebd2a9d01a" kindref="member">standby</ref>(self)<sp/>-&gt;<sp/>None:</highlight></codeline>
<codeline lineno="850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Standby<sp/>search<sp/>devices<sp/>and<sp/>create<sp/>incoming<sp/>connection<sp/>tasks.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="851"><highlight class="normal"></highlight></codeline>
<codeline lineno="852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loop:<sp/>AbstractEventLoop<sp/>=<sp/>asyncio.get_event_loop()</highlight></codeline>
<codeline lineno="853"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="854"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;sleep<sp/>task<sp/>create<sp/>(broadcasts)..&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="855" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2b51fa92e94e68a7ce1cfa9476beee3b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2b51fa92e94e68a7ce1cfa9476beee3b" kindref="member">__send_loop_sleep</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a68a3816075b8ed0c70771734a769c637" kindref="member">__send_loop_sleep</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aaf4e9059c5e6eb4c022552d5e2b61393" kindref="member">__send_loop_sleep</ref>__send_loop_sleep<sp/>=<sp/>loop.create_task(</highlight></codeline>
<codeline lineno="856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>asyncio.sleep(</highlight></codeline>
<codeline lineno="857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SEND_LOOP_MAX_SLEEP_TIME</highlight></codeline>
<codeline lineno="858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(len(self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue)<sp/>&gt;<sp/>0)</highlight></codeline>
<codeline lineno="859"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>1000000000</highlight></codeline>
<codeline lineno="860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="862"><highlight class="normal"></highlight></codeline>
<codeline lineno="863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;sleep<sp/>task<sp/>wait..&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="864"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>asyncio.wait([self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2b51fa92e94e68a7ce1cfa9476beee3b" kindref="member">__send_loop_sleep</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a68a3816075b8ed0c70771734a769c637" kindref="member">__send_loop_sleep</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aaf4e9059c5e6eb4c022552d5e2b61393" kindref="member">__send_loop_sleep</ref>__send_loop_sleep])</highlight></codeline>
<codeline lineno="865"><highlight class="normal"></highlight></codeline>
<codeline lineno="866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;sleep<sp/>task<sp/>done..&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>CancelledError:</highlight></codeline>
<codeline lineno="868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;sleep<sp/>cancelled1.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="869"><highlight class="normal"></highlight></codeline>
<codeline lineno="870" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa6b6ea4bb56f4c18b6906bab38c971a7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa6b6ea4bb56f4c18b6906bab38c971a7" kindref="member">read_incoming_tcp_con_task</ref>(</highlight></codeline>
<codeline lineno="871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="872"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>tuple[list[Any],<sp/>list[Any],<sp/>list[Any]]<sp/>|<sp/>None:</highlight></codeline>
<codeline lineno="873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Read<sp/>incoming<sp/>connections<sp/>on<sp/>tcp<sp/>socket.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="874"><highlight class="normal"></highlight></codeline>
<codeline lineno="875"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loop:<sp/>AbstractEventLoop<sp/>=<sp/>asyncio.get_event_loop()</highlight></codeline>
<codeline lineno="876"><highlight class="normal"></highlight></codeline>
<codeline lineno="877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>timeout_read:<sp/>float<sp/>=<sp/>0.3</highlight></codeline>
<codeline lineno="878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Read<sp/>again<sp/>tcp<sp/>port..&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="879"><highlight class="normal"></highlight></codeline>
<codeline lineno="880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>await<sp/>loop.run_in_executor(</highlight></codeline>
<codeline lineno="882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>select.select,</highlight></codeline>
<codeline lineno="884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp],</highlight></codeline>
<codeline lineno="885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[],</highlight></codeline>
<codeline lineno="886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[],</highlight></codeline>
<codeline lineno="887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>timeout_read,</highlight></codeline>
<codeline lineno="888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>CancelledError:</highlight></codeline>
<codeline lineno="890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;cancelled<sp/>tcp<sp/>reading.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="891"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception:</highlight></codeline>
<codeline lineno="892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a28f05e11005dfc83e537f9e2e85f54d5" kindref="member">bind_ports</ref>bind_ports():</highlight></codeline>
<codeline lineno="894"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight><highlight class="stringliteral">&quot;Error<sp/>binding<sp/>ports<sp/>udp<sp/>2222<sp/>and<sp/>tcp<sp/>3333.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="895"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="896"><highlight class="normal"></highlight></codeline>
<codeline lineno="897" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8b85c27ecdc845a205a4f36c38554ec8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8b85c27ecdc845a205a4f36c38554ec8" kindref="member">check_messages_time_to_live</ref>(self)<sp/>-&gt;<sp/>None:</highlight></codeline>
<codeline lineno="898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Check<sp/>message<sp/>queue<sp/>for<sp/>end<sp/>of<sp/>live<sp/>messages.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="899"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>to_del:<sp/>list[str]<sp/>=<sp/>[]</highlight></codeline>
<codeline lineno="900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>to_del<sp/>=<sp/>[]</highlight></codeline>
<codeline lineno="903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>uid,<sp/>msgs<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue.items():</highlight></codeline>
<codeline lineno="904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>msg<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>msgs:</highlight></codeline>
<codeline lineno="905"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>await<sp/>msg.check_msg_ttl():</highlight></codeline>
<codeline lineno="906"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msgs.remove(msg)</highlight></codeline>
<codeline lineno="907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue[uid]:</highlight></codeline>
<codeline lineno="908"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>del<sp/>self.message_queue[uid]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="909"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>to_del.append(uid)</highlight></codeline>
<codeline lineno="910"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="911"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>uid<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>to_del:</highlight></codeline>
<codeline lineno="912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>del<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue[uid]</highlight></codeline>
<codeline lineno="913"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>asyncio.sleep(0.05)</highlight></codeline>
<codeline lineno="914"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>asyncio.CancelledError:</highlight></codeline>
<codeline lineno="915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Message<sp/>queue<sp/>time<sp/>to<sp/>live<sp/>task<sp/>ended.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="916"><highlight class="normal"></highlight></codeline>
<codeline lineno="917" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aefd29b1e670e7076b749f7f21b0dc290" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aefd29b1e670e7076b749f7f21b0dc290" kindref="member">connection_tasks_time_to_live</ref>(</highlight></codeline>
<codeline lineno="918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,<sp/>proc_timeout_secs:<sp/>int<sp/>=<sp/>DEFAULT_MAX_COM_PROC_TIMEOUT_SECS</highlight></codeline>
<codeline lineno="919"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;End<sp/>connection<sp/>tasks<sp/>with<sp/>run<sp/>out<sp/>time<sp/>to<sp/>live.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tasks_undone_new:<sp/>list[Any]<sp/>=<sp/>[]</highlight></codeline>
<codeline lineno="923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>task,<sp/>started<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aad755d50b86f166cc07d60a73be07d27" kindref="member">__tasks_undone</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a317b8c3b4d3ebaa16eeaed026c561426" kindref="member">__tasks_undone</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac233ab5749ff539db60868d759194458" kindref="member">__tasks_undone</ref>__tasks_undone:</highlight></codeline>
<codeline lineno="924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>task.done():</highlight></codeline>
<codeline lineno="925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ada6417ada8d133670d693cfc41524ace" kindref="member">__tasks_done</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac9063fb97f6994d217bbf2de54e52284" kindref="member">__tasks_done</ref>__tasks_done.append(</highlight></codeline>
<codeline lineno="926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(task,<sp/>started,<sp/>datetime.datetime.now())</highlight></codeline>
<codeline lineno="927"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exception:<sp/>Any<sp/>=<sp/>task.exception()</highlight></codeline>
<codeline lineno="929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>exception:</highlight></codeline>
<codeline lineno="930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight></codeline>
<codeline lineno="931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Exception<sp/>error<sp/>device<sp/>connection<sp/>handler<sp/>task<sp/>in&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;<sp/>{task.get_coro()}:<sp/>{exception}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>datetime.datetime.now()<sp/>-<sp/>started<sp/>&gt;<sp/>datetime.timedelta(</highlight></codeline>
<codeline lineno="936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>seconds=proc_timeout_secs</highlight></codeline>
<codeline lineno="937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>task.cancel(</highlight></codeline>
<codeline lineno="939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg=(</highlight></codeline>
<codeline lineno="940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;timeout<sp/>of<sp/>process<sp/>of&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;<sp/>{proc_timeout_secs}<sp/>seconds.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tasks_undone_new.append((task,<sp/>started))</highlight></codeline>
<codeline lineno="945" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aad755d50b86f166cc07d60a73be07d27" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aad755d50b86f166cc07d60a73be07d27" kindref="member">__tasks_undone</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a317b8c3b4d3ebaa16eeaed026c561426" kindref="member">__tasks_undone</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac233ab5749ff539db60868d759194458" kindref="member">__tasks_undone</ref>__tasks_undone<sp/>=<sp/>tasks_undone_new</highlight></codeline>
<codeline lineno="946"><highlight class="normal"></highlight></codeline>
<codeline lineno="947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>CancelledError:</highlight></codeline>
<codeline lineno="948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;__tasks_undone<sp/>check<sp/>cancelled.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="949"><highlight class="normal"></highlight></codeline>
<codeline lineno="950" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a5e9277acd0b7bfa5a1e74417e0e10d86" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a5e9277acd0b7bfa5a1e74417e0e10d86" kindref="member">handle_incoming_tcp_connection</ref>(</highlight></codeline>
<codeline lineno="951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,<sp/>proc_timeout_secs:<sp/>int</highlight></codeline>
<codeline lineno="952"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Accept<sp/>incoming<sp/>tcp<sp/>connection<sp/>and<sp/>start<sp/>connection<sp/>handle</highlight></codeline>
<codeline lineno="954"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>process.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp:</highlight></codeline>
<codeline lineno="956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loop:<sp/>AbstractEventLoop<sp/>=<sp/>asyncio.get_event_loop()</highlight></codeline>
<codeline lineno="958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device:<sp/>Device<sp/>=<sp/><ref refid="classklyqa__ctl_1_1devices_1_1device_1_1Device" kindref="compound">Device</ref>()</highlight></codeline>
<codeline lineno="959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>addr:<sp/>tuple</highlight></codeline>
<codeline lineno="960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection:<sp/>TcpConnection<sp/>=<sp/>TcpConnection()</highlight></codeline>
<codeline lineno="961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight></codeline>
<codeline lineno="962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.socket,</highlight></codeline>
<codeline lineno="963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>addr,</highlight></codeline>
<codeline lineno="964"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)<sp/>=<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp.accept()</highlight></codeline>
<codeline lineno="965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>addr[0]<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e5e94d8da70d86c87eba78bcde9ff42" kindref="member">current_addr_connections</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a5c2443c4a93b9bfedd207119b0dbb9bc" kindref="member">current_addr_connections</ref>current_addr_connections:</highlight></codeline>
<codeline lineno="966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e5e94d8da70d86c87eba78bcde9ff42" kindref="member">current_addr_connections</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a5c2443c4a93b9bfedd207119b0dbb9bc" kindref="member">current_addr_connections</ref>current_addr_connections.add(addr[0])</highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.address[</highlight><highlight class="stringliteral">&quot;ip&quot;</highlight><highlight class="normal">]<sp/>=<sp/>addr[0]</highlight></codeline>
<codeline lineno="968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>connection.address[</highlight><highlight class="stringliteral">&quot;port&quot;</highlight><highlight class="normal">]<sp/>=<sp/>addr[1]</highlight></codeline>
<codeline lineno="969"><highlight class="normal"></highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_task:<sp/>Task[DeviceTcpReturn]<sp/>=<sp/>loop.create_task(</highlight></codeline>
<codeline lineno="971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0b582d0bf1523d1d0404867ab921539f" kindref="member">device_handle_local_tcp</ref>device_handle_local_tcp(device,<sp/>connection)</highlight></codeline>
<codeline lineno="972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="973"><highlight class="normal"></highlight></codeline>
<codeline lineno="974"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loop.create_task(</highlight></codeline>
<codeline lineno="975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>asyncio.wait_for(new_task,<sp/>timeout=proc_timeout_secs)</highlight></codeline>
<codeline lineno="976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="977"><highlight class="normal"></highlight></codeline>
<codeline lineno="978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight></codeline>
<codeline lineno="979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;Address<sp/>{connection.address[&apos;ip&apos;]}<sp/>process<sp/>task<sp/>created.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aad755d50b86f166cc07d60a73be07d27" kindref="member">__tasks_undone</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a317b8c3b4d3ebaa16eeaed026c561426" kindref="member">__tasks_undone</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac233ab5749ff539db60868d759194458" kindref="member">__tasks_undone</ref>__tasks_undone.append((new_task,<sp/>datetime.datetime.now()))</highlight></codeline>
<codeline lineno="982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(f</highlight><highlight class="stringliteral">&quot;Address<sp/>{addr[0]}<sp/>already<sp/>in<sp/>connection.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="984"><highlight class="normal"></highlight></codeline>
<codeline lineno="985" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa5d34422c7cb1784e408fef186a0b585" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa5d34422c7cb1784e408fef186a0b585" kindref="member">handle_connections</ref>(</highlight></codeline>
<codeline lineno="986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,<sp/>proc_timeout_secs:<sp/>int<sp/>=<sp/>DEFAULT_MAX_COM_PROC_TIMEOUT_SECS</highlight></codeline>
<codeline lineno="987"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>bool:</highlight></codeline>
<codeline lineno="988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Send<sp/>broadcast<sp/>and<sp/>make<sp/>tasks<sp/>for<sp/>incoming<sp/>tcp<sp/>connections.</highlight></codeline>
<codeline lineno="989"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="990"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Params:</highlight></codeline>
<codeline lineno="991"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>proc_timeout_secs:<sp/>max<sp/>timeout<sp/>in<sp/>seconds<sp/>for<sp/>a<sp/>device</highlight></codeline>
<codeline lineno="992"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>communication<sp/>handle<sp/>process</highlight></codeline>
<codeline lineno="993"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="994"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Returns:</highlight></codeline>
<codeline lineno="995"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>true:<sp/><sp/>on<sp/>success</highlight></codeline>
<codeline lineno="996"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>false:<sp/>on<sp/>exception<sp/>or<sp/>error</highlight></codeline>
<codeline lineno="997"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="998"><highlight class="normal"></highlight></codeline>
<codeline lineno="999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1000"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a828ca7aef56188a7dd4bd1b18b7cea85" kindref="member">handle_connections_task_end_now</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1acf31322d19d937f12f736c7f4c3d9f22" kindref="member">handle_connections_task_end_now</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac2ea1078fc435b2f80b549c4d17ab6d4" kindref="member">handle_connections_task_end_now</ref>handle_connections_task_end_now:</highlight></codeline>
<codeline lineno="1001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a28f05e11005dfc83e537f9e2e85f54d5" kindref="member">bind_ports</ref>bind_ports():</highlight></codeline>
<codeline lineno="1002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp<sp/></highlight><highlight class="keywordflow">or</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8707b5729524d2c0a4e5e1b2116d22c2" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a9ff5b865c574faa82b43f8578b0bd564" kindref="member">udp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a577fb1c5fd541b50f25314acf0f9ee84" kindref="member">udp</ref>udp:</highlight></codeline>
<codeline lineno="1004"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1005"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>for<sp/>debug<sp/>cursor<sp/>jump:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>a:<sp/>bool<sp/>=<sp/></highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>a:</highlight></codeline>
<codeline lineno="1008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1009"><highlight class="normal"></highlight></codeline>
<codeline lineno="1010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue:</highlight></codeline>
<codeline lineno="1011"><highlight class="normal"></highlight></codeline>
<codeline lineno="1012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>read_broadcast_response:<sp/>bool<sp/>=<sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a69a2aabf1a7bc94f925f914df5ceae10" kindref="member">send_udp_broadcast</ref>send_udp_broadcast():</highlight></codeline>
<codeline lineno="1014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>read_broadcast_response<sp/>=<sp/></highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1015"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1016"><highlight class="normal"></highlight></codeline>
<codeline lineno="1017"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>read_broadcast_response:</highlight></codeline>
<codeline lineno="1018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aed3640a60ff23b9532ca91ebd2a9d01a" kindref="member">standby</ref>standby()</highlight></codeline>
<codeline lineno="1019"><highlight class="normal"></highlight></codeline>
<codeline lineno="1020"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>read_broadcast_response:</highlight></codeline>
<codeline lineno="1021"><highlight class="normal"></highlight></codeline>
<codeline lineno="1022" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab01f2e382ae425e5bc2818772d059a56" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab01f2e382ae425e5bc2818772d059a56" kindref="member">__read_tcp_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a348da0cbea474b77e02a7960340aed36" kindref="member">__read_tcp_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab55d546556c0b8e39bd0f147765e233f" kindref="member">__read_tcp_task</ref>__read_tcp_task<sp/>=<sp/>asyncio.create_task(</highlight></codeline>
<codeline lineno="1023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa6b6ea4bb56f4c18b6906bab38c971a7" kindref="member">read_incoming_tcp_con_task</ref>read_incoming_tcp_con_task()</highlight></codeline>
<codeline lineno="1024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1025"><highlight class="normal"></highlight></codeline>
<codeline lineno="1026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Reading<sp/>incoming<sp/>connections..&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1027"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1028"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>asyncio.wait_for(</highlight></codeline>
<codeline lineno="1029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab01f2e382ae425e5bc2818772d059a56" kindref="member">__read_tcp_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a348da0cbea474b77e02a7960340aed36" kindref="member">__read_tcp_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab55d546556c0b8e39bd0f147765e233f" kindref="member">__read_tcp_task</ref>__read_tcp_task,<sp/>timeout=1.0</highlight></codeline>
<codeline lineno="1030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>asyncio.TimeoutError:</highlight></codeline>
<codeline lineno="1032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight></codeline>
<codeline lineno="1033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Socket-Timeout<sp/>for<sp/>incoming<sp/>tcp<sp/>connections.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1035"><highlight class="normal"></highlight></codeline>
<codeline lineno="1036"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>socket.error:</highlight></codeline>
<codeline lineno="1037"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight><highlight class="stringliteral">&quot;Socket<sp/>error!&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1038"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="1039"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a28f05e11005dfc83e537f9e2e85f54d5" kindref="member">bind_ports</ref>bind_ports():</highlight></codeline>
<codeline lineno="1040"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight></codeline>
<codeline lineno="1041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Error<sp/>binding<sp/>ports<sp/>udp<sp/>2222<sp/>and<sp/>tcp&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>3333.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1044"><highlight class="normal"></highlight></codeline>
<codeline lineno="1045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result:<sp/>tuple[</highlight></codeline>
<codeline lineno="1046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>list[Any],<sp/>list[Any],<sp/>list[Any]</highlight></codeline>
<codeline lineno="1047"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>]<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab01f2e382ae425e5bc2818772d059a56" kindref="member">__read_tcp_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a348da0cbea474b77e02a7960340aed36" kindref="member">__read_tcp_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab55d546556c0b8e39bd0f147765e233f" kindref="member">__read_tcp_task</ref>__read_tcp_task.result()</highlight></codeline>
<codeline lineno="1049"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab01f2e382ae425e5bc2818772d059a56" kindref="member">__read_tcp_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a348da0cbea474b77e02a7960340aed36" kindref="member">__read_tcp_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ab55d546556c0b8e39bd0f147765e233f" kindref="member">__read_tcp_task</ref>__read_tcp_task</highlight></codeline>
<codeline lineno="1050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="1053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>result</highlight></codeline>
<codeline lineno="1054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">or</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>isinstance(result,<sp/>tuple)</highlight></codeline>
<codeline lineno="1055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">or</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>len(result)<sp/>==<sp/>3</highlight></codeline>
<codeline lineno="1056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="1057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight></codeline>
<codeline lineno="1058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;No<sp/>incoming<sp/>tcp<sp/>connections<sp/>read<sp/>result.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>break&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>readable:<sp/>list[Any]</highlight></codeline>
<codeline lineno="1063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>readable,<sp/>_,<sp/>_<sp/>=<sp/>result<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>result<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>([],<sp/>[],<sp/>[])</highlight></codeline>
<codeline lineno="1064"><highlight class="normal"></highlight></codeline>
<codeline lineno="1065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;Reading<sp/>tcp<sp/>port<sp/>done..&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1066"><highlight class="normal"></highlight></codeline>
<codeline lineno="1067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a06a29b1bf1327ddeb687e4062ee1110d" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a00d69811c9433020eb1ec3b24383008e" kindref="member">tcp</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a0f8caa333a22c79922997c34d9d7b868" kindref="member">tcp</ref>tcp<sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>readable:</highlight></codeline>
<codeline lineno="1068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a5e9277acd0b7bfa5a1e74417e0e10d86" kindref="member">handle_incoming_tcp_connection</ref>handle_incoming_tcp_connection(</highlight></codeline>
<codeline lineno="1071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>proc_timeout_secs</highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1073"><highlight class="normal"></highlight></codeline>
<codeline lineno="1074"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>await<sp/>self.check_messages_time_to_live()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1075"><highlight class="normal"></highlight></codeline>
<codeline lineno="1076"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aefd29b1e670e7076b749f7f21b0dc290" kindref="member">connection_tasks_time_to_live</ref>connection_tasks_time_to_live(proc_timeout_secs)</highlight></codeline>
<codeline lineno="1077"><highlight class="normal"></highlight></codeline>
<codeline lineno="1078"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue:</highlight></codeline>
<codeline lineno="1079"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aed3640a60ff23b9532ca91ebd2a9d01a" kindref="member">standby</ref>standby()</highlight></codeline>
<codeline lineno="1080"><highlight class="normal"></highlight></codeline>
<codeline lineno="1081"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>CancelledError:</highlight></codeline>
<codeline lineno="1082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;search<sp/>and<sp/>send<sp/>to<sp/>device<sp/>loop<sp/>cancelled.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1083" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue<sp/>=<sp/>{}</highlight></codeline>
<codeline lineno="1084"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>task,<sp/>_<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aad755d50b86f166cc07d60a73be07d27" kindref="member">__tasks_undone</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a317b8c3b4d3ebaa16eeaed026c561426" kindref="member">__tasks_undone</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac233ab5749ff539db60868d759194458" kindref="member">__tasks_undone</ref>__tasks_undone:</highlight></codeline>
<codeline lineno="1085"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>task.cancel(msg=</highlight><highlight class="stringliteral">&quot;Search<sp/>and<sp/>send<sp/>loop<sp/>cancelled.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1086"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>exception:</highlight></codeline>
<codeline lineno="1087"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight></codeline>
<codeline lineno="1088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Exception<sp/>on<sp/>send<sp/>and<sp/>search<sp/>loop.<sp/>Stop<sp/>search<sp/>devices<sp/>loop!&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1089"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1090"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>exception</highlight></codeline>
<codeline lineno="1091"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight></codeline>
<codeline lineno="1092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Search<sp/>devices<sp/>and<sp/>process<sp/>incoming<sp/>connnections<sp/>loop<sp/>ended.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1094"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1095"><highlight class="normal"></highlight></codeline>
<codeline lineno="1096" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa780e39d1ce443d422a41064cc382d1f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa780e39d1ce443d422a41064cc382d1f" kindref="member">handle_connections_task_stop</ref>(self)<sp/>-&gt;<sp/>None:</highlight></codeline>
<codeline lineno="1097"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;End<sp/>device<sp/>search<sp/>and<sp/>connections<sp/>handler<sp/>task.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1098"><highlight class="normal"></highlight></codeline>
<codeline lineno="1099"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac3bb2f33c3dd9a46ba505569ec001ab3" kindref="member">msg_ttl_task</ref>msg_ttl_task<sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac3bb2f33c3dd9a46ba505569ec001ab3" kindref="member">msg_ttl_task</ref>msg_ttl_task.done():</highlight></codeline>
<codeline lineno="1100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac3bb2f33c3dd9a46ba505569ec001ab3" kindref="member">msg_ttl_task</ref>msg_ttl_task.cancel()</highlight></codeline>
<codeline lineno="1101"><highlight class="normal"></highlight></codeline>
<codeline lineno="1102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="1103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1f5deccf8a67169afa7e67c53cd569e5" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e62dc20801dc3d832dbd1dd0373ba17" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a44ce408a0cb35854a4ac1dfe541090b4" kindref="member">handle_connections_task</ref>handle_connections_task</highlight></codeline>
<codeline lineno="1104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1f5deccf8a67169afa7e67c53cd569e5" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e62dc20801dc3d832dbd1dd0373ba17" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a44ce408a0cb35854a4ac1dfe541090b4" kindref="member">handle_connections_task</ref>handle_connections_task.done()</highlight></codeline>
<codeline lineno="1105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="1106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;stop<sp/>send<sp/>and<sp/>search<sp/>loop.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1f5deccf8a67169afa7e67c53cd569e5" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e62dc20801dc3d832dbd1dd0373ba17" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a44ce408a0cb35854a4ac1dfe541090b4" kindref="member">handle_connections_task</ref>handle_connections_task:</highlight></codeline>
<codeline lineno="1108" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a828ca7aef56188a7dd4bd1b18b7cea85" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a828ca7aef56188a7dd4bd1b18b7cea85" kindref="member">handle_connections_task_end_now</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1acf31322d19d937f12f736c7f4c3d9f22" kindref="member">handle_connections_task_end_now</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac2ea1078fc435b2f80b549c4d17ab6d4" kindref="member">handle_connections_task_end_now</ref>handle_connections_task_end_now<sp/>=<sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1f5deccf8a67169afa7e67c53cd569e5" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e62dc20801dc3d832dbd1dd0373ba17" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a44ce408a0cb35854a4ac1dfe541090b4" kindref="member">handle_connections_task</ref>handle_connections_task.cancel(</highlight></codeline>
<codeline lineno="1110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg=</highlight><highlight class="stringliteral">&quot;Shutdown<sp/>search<sp/>and<sp/>send<sp/>loop.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;wait<sp/>for<sp/>send<sp/>and<sp/>search<sp/>loop<sp/>to<sp/>end.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>asyncio.wait_for(</highlight></codeline>
<codeline lineno="1115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1f5deccf8a67169afa7e67c53cd569e5" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e62dc20801dc3d832dbd1dd0373ba17" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a44ce408a0cb35854a4ac1dfe541090b4" kindref="member">handle_connections_task</ref>handle_connections_task,<sp/>timeout=0.1</highlight></codeline>
<codeline lineno="1116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;wait<sp/>end<sp/>for<sp/>send<sp/>and<sp/>search<sp/>loop.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception:</highlight></codeline>
<codeline lineno="1119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="1120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;wait<sp/>end<sp/>for<sp/>send<sp/>and<sp/>search<sp/>loop.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1121"><highlight class="normal"></highlight></codeline>
<codeline lineno="1122" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ae9be93d47c973e3c8afeed1b27fc7a4d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ae9be93d47c973e3c8afeed1b27fc7a4d" kindref="member">search_and_send_loop_task_alive</ref>(self)<sp/>-&gt;<sp/>None:</highlight></codeline>
<codeline lineno="1123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Ensure<sp/>broadcast&apos;s<sp/>and<sp/>connection<sp/>handler&apos;s<sp/>task<sp/>is<sp/>alive.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loop:<sp/>AbstractEventLoop<sp/>=<sp/>asyncio.get_event_loop()</highlight></codeline>
<codeline lineno="1125"><highlight class="normal"></highlight></codeline>
<codeline lineno="1126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac3bb2f33c3dd9a46ba505569ec001ab3" kindref="member">msg_ttl_task</ref>msg_ttl_task<sp/></highlight><highlight class="keywordflow">or</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac3bb2f33c3dd9a46ba505569ec001ab3" kindref="member">msg_ttl_task</ref>msg_ttl_task.done():</highlight></codeline>
<codeline lineno="1127" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac3bb2f33c3dd9a46ba505569ec001ab3" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ac3bb2f33c3dd9a46ba505569ec001ab3" kindref="member">msg_ttl_task</ref>msg_ttl_task<sp/>=<sp/>loop.create_task(</highlight></codeline>
<codeline lineno="1128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a8b85c27ecdc845a205a4f36c38554ec8" kindref="member">check_messages_time_to_live</ref>check_messages_time_to_live()</highlight></codeline>
<codeline lineno="1129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1130"><highlight class="normal"></highlight></codeline>
<codeline lineno="1131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="1132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1f5deccf8a67169afa7e67c53cd569e5" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e62dc20801dc3d832dbd1dd0373ba17" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a44ce408a0cb35854a4ac1dfe541090b4" kindref="member">handle_connections_task</ref>handle_connections_task</highlight></codeline>
<codeline lineno="1133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">or</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1f5deccf8a67169afa7e67c53cd569e5" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e62dc20801dc3d832dbd1dd0373ba17" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a44ce408a0cb35854a4ac1dfe541090b4" kindref="member">handle_connections_task</ref>handle_connections_task.done()</highlight></codeline>
<codeline lineno="1134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="1135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;search<sp/>and<sp/>send<sp/>loop<sp/>task<sp/>created.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1136" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1f5deccf8a67169afa7e67c53cd569e5" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1f5deccf8a67169afa7e67c53cd569e5" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a7e62dc20801dc3d832dbd1dd0373ba17" kindref="member">handle_connections_task</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a44ce408a0cb35854a4ac1dfe541090b4" kindref="member">handle_connections_task</ref>handle_connections_task<sp/>=<sp/>loop.create_task(</highlight></codeline>
<codeline lineno="1137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa5d34422c7cb1784e408fef186a0b585" kindref="member">handle_connections</ref>handle_connections()</highlight></codeline>
<codeline lineno="1138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2b51fa92e94e68a7ce1cfa9476beee3b" kindref="member">__send_loop_sleep</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a68a3816075b8ed0c70771734a769c637" kindref="member">__send_loop_sleep</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aaf4e9059c5e6eb4c022552d5e2b61393" kindref="member">__send_loop_sleep</ref>__send_loop_sleep<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2b51fa92e94e68a7ce1cfa9476beee3b" kindref="member">__send_loop_sleep</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a68a3816075b8ed0c70771734a769c637" kindref="member">__send_loop_sleep</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aaf4e9059c5e6eb4c022552d5e2b61393" kindref="member">__send_loop_sleep</ref>__send_loop_sleep.cancel()</highlight></codeline>
<codeline lineno="1142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception:</highlight></codeline>
<codeline lineno="1143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ad6b753e482e539892c57f8144cf213cb" kindref="member">task_log_trace_ex</ref>()</highlight></codeline>
<codeline lineno="1144"><highlight class="normal"></highlight></codeline>
<codeline lineno="1145" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aae9d106df606f3c68a146e0af7f60bba" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aae9d106df606f3c68a146e0af7f60bba" kindref="member">send_message</ref>(</highlight></codeline>
<codeline lineno="1146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="1147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>send_msgs:<sp/>list[Command],</highlight></codeline>
<codeline lineno="1148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>target_device_uid:<sp/>UnitId,</highlight></codeline>
<codeline lineno="1149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_to_live_secs:<sp/>float<sp/>=<sp/>-1.0,</highlight></codeline>
<codeline lineno="1150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>**kwargs:<sp/>Any,</highlight></codeline>
<codeline lineno="1151"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>Message<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Add<sp/>message<sp/>to<sp/>message&apos;s<sp/>queue.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>send_msgs:</highlight></codeline>
<codeline lineno="1154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LOGGER.error(</highlight></codeline>
<codeline lineno="1155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;No<sp/>message<sp/>queue<sp/>to<sp/>send<sp/>in<sp/>message<sp/>to<sp/>{target_device_uid}!&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1158"><highlight class="normal"></highlight></codeline>
<codeline lineno="1159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>response_event:<sp/>asyncio.Event<sp/>=<sp/>asyncio.Event()</highlight></codeline>
<codeline lineno="1160"><highlight class="normal"></highlight></codeline>
<codeline lineno="1161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal">answer(</highlight></codeline>
<codeline lineno="1162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg:<sp/>Message<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">,<sp/>unit_id:<sp/>str<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>response_event.set()</highlight></codeline>
<codeline lineno="1165"><highlight class="normal"></highlight></codeline>
<codeline lineno="1166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg:<sp/>Message<sp/>=<sp/><ref refid="classklyqa__ctl_1_1general_1_1message_1_1Message" kindref="compound">Message</ref>(</highlight></codeline>
<codeline lineno="1167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>datetime.datetime.now(),</highlight></codeline>
<codeline lineno="1168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>target_device_uid,</highlight></codeline>
<codeline lineno="1169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_queue=send_msgs,</highlight></codeline>
<codeline lineno="1170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>callback=answer,</highlight></codeline>
<codeline lineno="1171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_to_live_secs=time_to_live_secs,</highlight></codeline>
<codeline lineno="1172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>**kwargs,</highlight></codeline>
<codeline lineno="1173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1174"><highlight class="normal"></highlight></codeline>
<codeline lineno="1175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>await<sp/>msg.check_msg_ttl():</highlight></codeline>
<codeline lineno="1176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>msg</highlight></codeline>
<codeline lineno="1177"><highlight class="normal"></highlight></codeline>
<codeline lineno="1178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1ab2f9a22e98cd16d0d284d22382cfcb02" kindref="member">task_log_trace</ref>(</highlight></codeline>
<codeline lineno="1179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;new<sp/>message<sp/>{msg.msg_counter}<sp/>target&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;<sp/>{target_device_uid}<sp/>{send_msgs}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1182"><highlight class="normal"></highlight></codeline>
<codeline lineno="1183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aa8d21a3d613da986068dc05e8ea8c4a7" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a2c8ccb41ccfd636bd8a02042034375e8" kindref="member">message_queue</ref><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a1fc09795d2fca9fcaf4ef67f48810ce2" kindref="member">message_queue</ref>message_queue.setdefault(<ref refid="classstr" kindref="compound">str</ref>(target_device_uid),<sp/>[]).append(msg)</highlight></codeline>
<codeline lineno="1184"><highlight class="normal"></highlight></codeline>
<codeline lineno="1185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1a69a2aabf1a7bc94f925f914df5ceae10" kindref="member">send_udp_broadcast</ref>send_udp_broadcast()</highlight></codeline>
<codeline lineno="1186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ae9be93d47c973e3c8afeed1b27fc7a4d" kindref="member">search_and_send_loop_task_alive</ref>search_and_send_loop_task_alive()</highlight></codeline>
<codeline lineno="1187"><highlight class="normal"></highlight></codeline>
<codeline lineno="1188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>response_event.wait()</highlight></codeline>
<codeline lineno="1189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>msg</highlight></codeline>
<codeline lineno="1190"><highlight class="normal"></highlight></codeline>
<codeline lineno="1191" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1af714f4a1c0791c62d2d3990990a42cf4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>async<sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1af714f4a1c0791c62d2d3990990a42cf4" kindref="member">discover_devices</ref>(</highlight></codeline>
<codeline lineno="1192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="1193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>timeout_secs:<sp/>float<sp/>=<sp/>2.5,</highlight></codeline>
<codeline lineno="1194"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Discover<sp/>devices.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1196"><highlight class="normal"></highlight></codeline>
<codeline lineno="1197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>print(SEPARATION_WIDTH<sp/>*<sp/></highlight><highlight class="stringliteral">&quot;-&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>print(</highlight><highlight class="stringliteral">&quot;Search<sp/>local<sp/>network<sp/>for<sp/>devices<sp/>...&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>print(SEPARATION_WIDTH<sp/>*<sp/></highlight><highlight class="stringliteral">&quot;-&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1200"><highlight class="normal"></highlight></codeline>
<codeline lineno="1201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceklyqa__ctl_1_1general_1_1general_1a1afe30a73cc28a3b65babeeab27e36c8" kindref="member">task_log_debug</ref>(</highlight><highlight class="stringliteral">&quot;discover<sp/>ping<sp/>start&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>send<sp/>a<sp/>message<sp/>to<sp/>uid<sp/>&quot;all&quot;<sp/>which<sp/>is<sp/>fake<sp/>but<sp/>will<sp/>get<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>identification<sp/>message<sp/>from<sp/>the<sp/>devices<sp/>in<sp/>the<sp/>aes_search</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>and<sp/>send<sp/>msg<sp/>function<sp/>and<sp/>we<sp/>can<sp/>send<sp/>then<sp/>a<sp/>real</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>request<sp/>message<sp/>to<sp/>these<sp/>discovered<sp/>devices.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>self.<ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1aae9d106df606f3c68a146e0af7f60bba" kindref="member">send_message</ref>send_message(</highlight></codeline>
<codeline lineno="1207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[<ref refid="classklyqa__ctl_1_1devices_1_1light_1_1commands_1_1PingCommand" kindref="compound">PingCommand</ref>()],</highlight></codeline>
<codeline lineno="1208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classklyqa__ctl_1_1general_1_1unit__id_1_1UnitId" kindref="compound">UnitId</ref>(</highlight><highlight class="stringliteral">&quot;all&quot;</highlight><highlight class="normal">),</highlight></codeline>
<codeline lineno="1209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>timeout_secs,</highlight></codeline>
<codeline lineno="1210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1211"><highlight class="normal"></highlight></codeline>
<codeline lineno="1212"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@classmethod</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1213" refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ad2b49f5fff5ca621ba06840d5f550666" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler_1ad2b49f5fff5ca621ba06840d5f550666" kindref="member">create_default</ref>(</highlight></codeline>
<codeline lineno="1214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cls:<sp/>Any,</highlight></codeline>
<codeline lineno="1215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>controller_data:<sp/>ControllerData,</highlight></codeline>
<codeline lineno="1216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>server_ip:<sp/>str<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;0.0.0.0&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>network_interface:<sp/>str<sp/>|<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1218"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>LocalConnectionHandler:</highlight></codeline>
<codeline lineno="1219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Factory<sp/>for<sp/>local<sp/>only<sp/>controller.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc_hdl:<sp/>LocalConnectionHandler<sp/>=<sp/><ref refid="classlocal_1_1connection__handler_1_1LocalConnectionHandler" kindref="compound">LocalConnectionHandler</ref>(</highlight></codeline>
<codeline lineno="1221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>controller_data,</highlight></codeline>
<codeline lineno="1222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>server_ip=server_ip,</highlight></codeline>
<codeline lineno="1223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>network_interface=network_interface,</highlight></codeline>
<codeline lineno="1224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1225"><highlight class="normal"></highlight></codeline>
<codeline lineno="1226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>lc_hdl</highlight></codeline>
    </programlisting>
    <location file="communication/local/connection_handler.py"/>
  </compounddef>
</doxygen>
