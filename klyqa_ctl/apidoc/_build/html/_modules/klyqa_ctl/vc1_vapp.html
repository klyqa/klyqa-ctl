
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>klyqa_ctl.vc1_vapp &#8212; klyqa_ctl  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for klyqa_ctl.vc1_vapp</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">select</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Cryptodome.Cipher</span> <span class="kn">import</span> <span class="n">AES</span> <span class="c1"># provided by pycryptodome</span>
    <span class="kn">from</span> <span class="nn">Cryptodome.Random</span> <span class="kn">import</span> <span class="n">get_random_bytes</span> <span class="c1"># pycryptodome</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span> <span class="c1"># provided by pycryptodome</span>
    <span class="kn">from</span> <span class="nn">Crypto.Random</span> <span class="kn">import</span> <span class="n">get_random_bytes</span> <span class="c1"># pycryptodome</span>


<span class="c1"># sub-command functions</span>
<div class="viewcode-block" id="foo"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.foo">[docs]</a><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">y</span><span class="p">)</span></div>

<div class="viewcode-block" id="bar"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.bar">[docs]</a><span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;((</span><span class="si">%s</span><span class="s1">))&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">z</span><span class="p">)</span></div>

<span class="c1"># create the top-level parser</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">()</span>

<span class="c1"># create the parser for the &quot;foo&quot; command</span>
<span class="n">parser_foo</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="n">parser_foo</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-x&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">parser_foo</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">parser_foo</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">foo</span><span class="p">)</span>

<span class="c1"># create the parser for the &quot;bar&quot; command</span>
<span class="n">parser_bar</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">parser_bar</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
<span class="n">parser_bar</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">bar</span><span class="p">)</span>


<span class="c1"># parse the args and call whatever function was selected</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="s1">&#39;foo 1.3 -x 2&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">args</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="sendMsg"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.sendMsg">[docs]</a><span class="k">def</span> <span class="nf">sendMsg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">aes</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sending: &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">plain</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">plain</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">:</span>
        <span class="n">plain</span> <span class="o">=</span> <span class="n">plain</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">([</span><span class="mh">0x20</span><span class="p">])</span>

    <span class="n">cipher</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">plain</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">con</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">cipher</span><span class="p">)</span> <span class="o">//</span> <span class="mi">256</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cipher</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">cipher</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Send timed out, retrying...&quot;</span><span class="p">)</span>
            <span class="k">pass</span></div>



<span class="k">class</span> <span class="nc">_HelpAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">_HelpAction</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>

        <span class="c1"># retrieve subparsers from parser</span>
        <span class="n">subparsers_actions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">action</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_actions</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">argparse</span><span class="o">.</span><span class="n">_SubParsersAction</span><span class="p">)]</span>
        <span class="c1"># there will probably only be one subparser_action,</span>
        <span class="c1"># but better save than sorry</span>
        <span class="k">for</span> <span class="n">subparsers_action</span> <span class="ow">in</span> <span class="n">subparsers_actions</span><span class="p">:</span>
            <span class="c1"># get all subparsers and print help</span>
            <span class="k">for</span> <span class="n">choice</span><span class="p">,</span> <span class="n">subparser</span> <span class="ow">in</span> <span class="n">subparsers_action</span><span class="o">.</span><span class="n">choices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;subcommand </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">subparser</span><span class="o">.</span><span class="n">format_help</span><span class="p">())</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<div class="viewcode-block" id="set_thingsboard"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.set_thingsboard">[docs]</a><span class="k">def</span> <span class="nf">set_thingsboard</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span> <span class="o">=</span> <span class="n">set_up_sockets</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">con</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">connect_sockets</span><span class="p">(</span><span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span><span class="p">)</span>
    <span class="n">message_queue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;backend&quot;</span><span class="p">,</span> <span class="s2">&quot;link_enabled&quot;</span> <span class="p">:</span>  <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">permission</span> <span class="o">==</span> <span class="s2">&quot;enable&quot;</span><span class="p">)}),</span> <span class="mi">100</span><span class="p">)]</span>
    <span class="n">send_message_queue</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div>
<div class="viewcode-block" id="set_ota"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.set_ota">[docs]</a><span class="k">def</span> <span class="nf">set_ota</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span> <span class="o">=</span> <span class="n">set_up_sockets</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">con</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">connect_sockets</span><span class="p">(</span><span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span><span class="p">)</span>
    <span class="n">message_queue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;fw_update&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span> <span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">url</span><span class="p">}),</span> <span class="mi">300</span><span class="p">)]</span>
    <span class="n">send_message_queue</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div>
<div class="viewcode-block" id="set_ping"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.set_ping">[docs]</a><span class="k">def</span> <span class="nf">set_ping</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span> <span class="o">=</span> <span class="n">set_up_sockets</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">con</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">connect_sockets</span><span class="p">(</span><span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span><span class="p">)</span>
    <span class="n">message_queue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;ping&quot;</span> <span class="p">}),</span> <span class="mi">800</span><span class="p">)]</span>
    <span class="n">send_message_queue</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div>
<div class="viewcode-block" id="set_factory_reset"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.set_factory_reset">[docs]</a><span class="k">def</span> <span class="nf">set_factory_reset</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span> <span class="o">=</span> <span class="n">set_up_sockets</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">con</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">connect_sockets</span><span class="p">(</span><span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span><span class="p">)</span>
    <span class="n">message_queue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;factory_reset&quot;</span> <span class="p">}),</span> <span class="mi">500</span><span class="p">)]</span>
    <span class="n">send_message_queue</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div>
<div class="viewcode-block" id="set_reboot"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.set_reboot">[docs]</a><span class="k">def</span> <span class="nf">set_reboot</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span> <span class="o">=</span> <span class="n">set_up_sockets</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">con</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">connect_sockets</span><span class="p">(</span><span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span><span class="p">)</span>
    <span class="n">message_queue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;reboot&quot;</span> <span class="p">}),</span> <span class="mi">100</span><span class="p">)]</span>
    <span class="n">send_message_queue</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="set_state_request"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.set_state_request">[docs]</a><span class="k">def</span> <span class="nf">set_state_request</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span> <span class="o">=</span> <span class="n">set_up_sockets</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">con</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">connect_sockets</span><span class="p">(</span><span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span><span class="p">)</span>
    <span class="n">get_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;request&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">:</span><span class="s2">&quot;get&quot;</span><span class="p">,}</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">power</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;power&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cleaning</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;cleaning&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">beeping</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;beeping&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">battery</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;battery&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">sidebrush</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;sidebrush&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">rollingbrush</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;rollingbrush&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">filter</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">carpetbooster</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;carpetbooster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">area</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">time</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">calibrationtime</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;calibrationtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">workingmode</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;workingmode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">workstatus</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;workstatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">suction</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;suction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">water</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;water&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">direction</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">errors</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cleaningrec</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;cleaningrec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">equipmentmodel</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;equipmentmodel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">alarmmessages</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;alarmmessages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">commissioninfo</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;commissioninfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mcu</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">get_dict</span><span class="p">[</span><span class="s2">&quot;mcu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">message_queue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">get_dict</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)]</span>
    <span class="n">send_message_queue</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="set_set"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.set_set">[docs]</a><span class="k">def</span> <span class="nf">set_set</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span> <span class="o">=</span> <span class="n">set_up_sockets</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">con</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">connect_sockets</span><span class="p">(</span><span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span><span class="p">)</span>
    <span class="n">set_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;request&quot;</span><span class="p">,</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span><span class="s2">&quot;set&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;power&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">power</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cleaning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;cleaning&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">cleaning</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">beeping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;beeping&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">beeping</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">carpetbooster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;carpetbooster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">carpetbooster</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">workingmode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;workingmode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">workingmode</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">suction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;suction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">suction</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">water</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;water&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">water</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">direction</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">commissioninfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;commissioninfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">commissioninfo</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">calibrationtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;calibrationtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">calibrationtime</span>
    <span class="n">message_queue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">set_dict</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)]</span>
    <span class="n">send_message_queue</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="set_reset"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.set_reset">[docs]</a><span class="k">def</span> <span class="nf">set_reset</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span> <span class="o">=</span> <span class="n">set_up_sockets</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">con</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">connect_sockets</span><span class="p">(</span><span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span><span class="p">)</span>
    <span class="n">reset_dict</span> <span class="o">=</span> <span class="p">{</span> 
            <span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;request&quot;</span><span class="p">,</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;reset&quot;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">sidebrush</span><span class="p">:</span>
        <span class="n">reset_dict</span><span class="p">[</span><span class="s2">&quot;sidebrush&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">rollingbrush</span><span class="p">:</span>
        <span class="n">reset_dict</span><span class="p">[</span><span class="s2">&quot;rollingbrush&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">filter</span><span class="p">:</span>
        <span class="n">reset_dict</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">message_queue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">reset_dict</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)]</span>
    <span class="n">send_message_queue</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="do_passive"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.do_passive">[docs]</a><span class="k">def</span> <span class="nf">do_passive</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for UDP broadcast&quot;</span><span class="p">)</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">udp</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> 2. UDP server received: &quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s2">&quot;from&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3a. Sending UDP ack.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">udp</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="s1">&#39;QCX-ACK&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">address</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3b. Sending UDP ack.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">udp</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="s1">&#39;QCX-ACK&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">address</span><span class="p">)</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="set_up_sockets"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.set_up_sockets">[docs]</a><span class="k">def</span> <span class="nf">set_up_sockets</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">tcp</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">tcp</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="mi">3333</span><span class="p">)</span>
    <span class="n">tcp</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
    <span class="n">tcp</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">udp</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
    <span class="n">udp</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_BROADCAST</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">udp</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">myip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">myip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2222</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="mi">2222</span><span class="p">)</span>
    <span class="n">udp</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span></div>

<div class="viewcode-block" id="connect_sockets"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.connect_sockets">[docs]</a><span class="k">def</span> <span class="nf">connect_sockets</span><span class="p">(</span><span class="n">tcp</span><span class="p">,</span> <span class="n">udp</span><span class="p">):</span>
    <span class="n">con</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">con</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Broadcasting QCX-SYN Burst</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">udp</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="s1">&#39;QCX-SYN&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;255.255.255.255&#39;</span><span class="p">,</span> <span class="mi">2222</span><span class="p">))</span>
        <span class="n">readable</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">tcp</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tcp</span> <span class="ow">in</span> <span class="n">readable</span><span class="p">:</span>
            <span class="n">con</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">tcp</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TCP layer connected&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">con</span><span class="p">,</span> <span class="n">address</span></div>

<div class="viewcode-block" id="send_message_queue"><a class="viewcode-back" href="../../klyqa_ctl.html#klyqa_ctl.vc1_vapp.send_message_queue">[docs]</a><span class="k">def</span> <span class="nf">send_message_queue</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">message_queue_tx</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;WAIT_IV&#39;</span>
    <span class="n">localIv</span> <span class="o">=</span> <span class="n">get_random_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">sendingAES</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">receivingAES</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">message_queue_tx</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">last_send</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">con</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">.001</span><span class="p">)</span>
    <span class="n">pause</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_send</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">aes_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">AES_KEY</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">aes_key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">AES_KEY</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">])</span>
        
    <span class="n">timeout</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">11000</span><span class="p">)</span>
    <span class="n">started</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> 
    <span class="n">received_finish</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">received_answer</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="p">((</span><span class="ow">not</span> <span class="n">received_finish</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">received_answer</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">message_queue_tx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">pause</span><span class="p">)</span>
    <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">started</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EOF&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_send</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;CONNECTED&#39;</span><span class="p">:</span>
            <span class="n">send_next</span> <span class="o">=</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">pause</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message_queue_tx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">send_next</span><span class="p">:</span>
                <span class="n">msg</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">message_queue_tx</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">pause</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>
                <span class="n">sendMsg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">sendingAES</span><span class="p">)</span>
                <span class="n">last_send</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TCP server received &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="s2">&quot; bytes from &quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">([</span><span class="nb">hex</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>

            <span class="n">pkgLen</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pkgType</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

            <span class="n">pkg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="o">+</span><span class="n">pkgLen</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pkgLen</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Incomplete packet, waiting for more...&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="n">pkgLen</span><span class="p">:]</span>

            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;WAIT_IV&#39;</span> <span class="ow">and</span> <span class="n">pkgType</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plain: &quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>

                <span class="n">con</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">localIv</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;WAIT_IV&#39;</span> <span class="ow">and</span> <span class="n">pkgType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">remoteIv</span> <span class="o">=</span> <span class="n">pkg</span>


                <span class="n">sendingAES</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">AES_KEY</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="o">=</span><span class="n">localIv</span> <span class="o">+</span> <span class="n">remoteIv</span><span class="p">)</span>
                <span class="n">receivingAES</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">AES_KEY</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="o">=</span><span class="n">remoteIv</span> <span class="o">+</span> <span class="n">localIv</span><span class="p">)</span>

                <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;CONNECTED&#39;</span>

            <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;CONNECTED&#39;</span> <span class="ow">and</span> <span class="n">pkgType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">received_finish</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">received_answer</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">cipher</span> <span class="o">=</span> <span class="n">pkg</span>

                <span class="n">plain</span> <span class="o">=</span> <span class="n">receivingAES</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">cipher</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Decrypted: &quot;</span><span class="p">,</span> <span class="n">plain</span><span class="p">)</span></div>
                
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;virtual App interface for the vc1&quot;</span><span class="p">,</span> <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Device independent </span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--myip&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ip&#39;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;specify own IP for broadcast sender&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--aes_key&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;aes_string&#39;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;specify aes key&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;--help&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">_HelpAction</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;show this help message and exit&#39;</span><span class="p">)</span>
    <span class="c1"># grp = parser.add_mutually_exclusive_group(required=False)</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;subcommands&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;command&#39;</span><span class="p">)</span>
    
    <span class="n">tb</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;thingsboard&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;change thingsboard connection permission&#39;</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;permission&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;enable&#39;</span><span class="p">,</span> <span class="s1">&#39;disable&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;whether it should be enabled or disabled&#39;</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">set_thingsboard</span><span class="p">)</span>
    <span class="n">pssv</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;passive&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;vApp will passively listen for UDP SYN from devices&#39;</span><span class="p">)</span>
    <span class="n">pssv</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">do_passive</span><span class="p">)</span>
    <span class="n">ota</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;ota&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;allows over the air programming of the device&#39;</span><span class="p">)</span>
    <span class="n">ota</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;specify http URL for ota&#39;</span><span class="p">)</span>
    <span class="n">ota</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">set_ota</span><span class="p">)</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;send a ping and nothing else&#39;</span><span class="p">)</span>
    <span class="n">ping</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">set_ping</span><span class="p">)</span>
    <span class="n">frs</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;factory-reset&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;trigger a factory reset on the device - the device has to be onboarded again afterwards)&#39;</span><span class="p">)</span>
    <span class="n">frs</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">set_factory_reset</span><span class="p">)</span>
    <span class="n">reb</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;reboot&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;trigger a reboot&#39;</span><span class="p">)</span>
    <span class="n">reb</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">set_reboot</span><span class="p">)</span>
    
    <span class="n">req</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;send state request&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--all&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the whole state will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--power&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cleaning&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--beeping&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--battery&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sidebrush&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--rollingbrush&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--filter&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--carpetbooster&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--area&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--time&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--calibrationtime&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--workingmode&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--workstatus&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--suction&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--water&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--direction&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--errors&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cleaningrec&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--equipmentmodel&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--alarmmessages&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--commissioninfo&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this flag is set, the state element will be requested&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--mcu&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ask if mcu is online&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">set_state_request</span><span class="p">)</span>

    <span class="c1">#device specific</span>
    <span class="n">set_parser</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;enables use of the vc1 control arguments and will control vc1&#39;</span><span class="p">)</span>
    <span class="n">set_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--power&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;turn power on/off&#39;</span><span class="p">)</span>
    <span class="n">set_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cleaning&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;turn cleaning on/off&#39;</span><span class="p">)</span>
    <span class="n">set_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--beeping&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;enable/disable the find-vc function&#39;</span><span class="p">)</span>
    <span class="n">set_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--carpetbooster&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;strength&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;set the carpet booster strength (0-255)&#39;</span><span class="p">)</span>
    <span class="n">set_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--workingmode&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;STANDBY&#39;</span><span class="p">,</span> <span class="s1">&#39;SMART&#39;</span><span class="p">,</span> <span class="s1">&#39;MOP&#39;</span><span class="p">,</span> <span class="s1">&#39;WALL_FOLLOW&#39;</span><span class="p">,</span> <span class="s1">&#39;PARTIAL_BOW&#39;</span><span class="p">,</span> <span class="s1">&#39;SPIRAL&#39;</span><span class="p">,</span> <span class="s1">&#39;CHARGE_GO&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;set the working mode&#39;</span><span class="p">)</span>
    <span class="n">set_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--water&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;LOW&#39;</span><span class="p">,</span> <span class="s1">&#39;MID&#39;</span><span class="p">,</span> <span class="s1">&#39;HIGH&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;set water quantity&#39;</span><span class="p">)</span>
    <span class="n">set_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--suction&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;LOW&#39;</span><span class="p">,</span> <span class="s1">&#39;MID&#39;</span><span class="p">,</span> <span class="s1">&#39;HIGH&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;set suction power&#39;</span><span class="p">)</span>
    <span class="n">set_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--direction&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FORWARDS&#39;</span><span class="p">,</span><span class="s1">&#39;BACKWARDS&#39;</span><span class="p">,</span> <span class="s1">&#39;TURN_LEFT&#39;</span><span class="p">,</span> <span class="s1">&#39;TURN_RIGHT&#39;</span><span class="p">,</span> <span class="s1">&#39;STOP&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;manually control movement&#39;</span><span class="p">)</span>
    <span class="n">set_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--commissioninfo&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;set up to 256 characters of commisioning info&#39;</span><span class="p">)</span>
    <span class="n">set_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--calibrationtime&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;set the calibration time (1-1999999999)&#39;</span><span class="p">)</span>
    <span class="n">set_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">set_set</span><span class="p">)</span>

    <span class="n">reset_parser</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;enables resetting consumables&#39;</span><span class="p">)</span>
    <span class="n">reset_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sidebrush&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;resets the sidebrush life counter&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">reset_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--rollingbrush&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;resets the rollingbrush life counter&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">reset_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--filter&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;resets the filter life counter&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">reset_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">set_reset</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">args</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    


    <span class="c1"># data, address = udp.recvfrom(4096)</span>
    <span class="c1"># print(&quot;\n\n 2. UDP server received: &quot;, data.decode(&#39;utf-8&#39;), &quot;from&quot;, address, &quot;\n\n&quot;)</span>

    <span class="c1"># state = &#39;WAIT_IV&#39;</span>
    <span class="c1"># localIv = get_random_bytes(8)</span>

    <span class="c1"># sendingAES = None</span>
    <span class="c1"># receivingAES = None</span>

    <span class="c1"># message_queue_tx = []</span>

    <span class="c1"># if args.command == &#39;ota&#39;:</span>
    <span class="c1">#     message_queue_tx.append((json.dumps( { &quot;type&quot; : &quot;fw_update&quot;, &quot;url&quot; : args.ota}), 3000))</span>

    <span class="c1"># elif args.command == &#39;ping&#39;:</span>
    <span class="c1">#     message_queue_tx.append((json.dumps( { &quot;type&quot; : &quot;ping&quot; }), 10000))</span>

    <span class="c1"># if args.command == &#39;thingsboard&#39;:</span>
    <span class="c1">#     message_queue_tx.append()</span>

    <span class="c1"># if args.factory_reset:</span>
    <span class="c1">#     message_queue_tx.append()</span>

    <span class="c1"># if args.routine_list:</span>
    <span class="c1">#     message_queue_tx.append((json.dumps( { &quot;type&quot; : &quot;routine&quot;, &quot;action&quot;: &quot;list&quot; }), 500))</span>

    <span class="c1"># if args.routine_put:</span>
    <span class="c1">#     message_queue_tx.append((json.dumps( {</span>
    <span class="c1">#         &quot;type&quot; : &quot;routine&quot;, &quot;action&quot;: &quot;put&quot;,</span>
    <span class="c1">#         &quot;id&quot;: args.routine_id, &quot;scene&quot;: args.routine_scene,</span>
    <span class="c1">#         &quot;commands&quot;:  args.routine_commands</span>
    <span class="c1">#     }), 500))</span>

    <span class="c1"># if args.routine_delete:</span>
    <span class="c1">#     message_queue_tx.append((json.dumps( {</span>
    <span class="c1">#         &quot;type&quot; : &quot;routine&quot;, &quot;action&quot;: &quot;delete&quot;, &quot;id&quot;: args.routine_id }), 500))</span>
    <span class="c1"># if args.routine_start:</span>
    <span class="c1">#     message_queue_tx.append((json.dumps( {</span>
    <span class="c1">#         &quot;type&quot; : &quot;routine&quot;, &quot;action&quot;: &quot;start&quot;, &quot;id&quot;: args.routine_id }), 500))    </span>
            
    <span class="c1"># if args.power:</span>
    <span class="c1">#     message_queue_tx.append((json.dumps( {</span>
    <span class="c1">#         &quot;type&quot; : &quot;request&quot;, &quot;status&quot;: args.power[0] }), 500))</span>

    <span class="c1"># if args.reboot:</span>
    <span class="c1">#     </span>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">klyqa_ctl</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../klyqa_ctl.html">klyqa_ctl package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.1.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>